<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#f7e0ea"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    :root{ --brand:#ea4c89 }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #e5e7eb; background:#fff }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .45rem; border-radius:.5rem; background:#f8fafc; border:1px solid #e5e7eb; font-size:.75rem }
    .card{ border:1px solid #e5e7eb; background:#fff; border-radius:1rem }
    .pill{ padding:.25rem .5rem; border-radius:.5rem; background:#fff; border:1px solid #e5e7eb; font-size:.7rem }
    .soft{ background:linear-gradient(#ffeaf3,#fbeff6) }
    .list-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.75rem }
    @media (max-width: 1024px) { .list-grid{ grid-template-columns:1fr } }
    /* ‚Äî‚Äî Pok√©mon card image placement (your request) ‚Äî‚Äî */
    .pk-card{ position:relative; }
    .pk-img-box{
      position:absolute; right:.75rem; top:50%; transform:translateY(-50%);
      width:120px; height:120px;        /* a bit larger but still modest */
      display:flex; align-items:center; justify-content:center;
      border-radius:.75rem; overflow:hidden; background:#fff8;
    }
    .pk-img-box img{ max-width:100%; max-height:100%; object-fit:contain; }
    /* keep left content readable with image on right */
    .pk-left{ padding-right:140px; }     /* leave room for the image box */
  </style>
</head>
<body class="bg-rose-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-4">
    <!-- Header -->
    <header class="space-y-3">
      <div class="rounded-2xl overflow-hidden">
        <img src="./Header.jpg" class="w-full max-h-48 object-cover soft" alt="">
      </div>
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="brand text-2xl font-bold">üå∏ JJBlossoms <span class="text-xs align-top">SHOP</span></span>
          <span class="pill text-slate-600">Data source: <b>Firebase (Live)</b></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnReq" class="btn">üìù Requests</button>
          <button id="btnReload" class="btn">üîÑ Reload data</button>
          <a href="./admin.html" class="btn">üîß Admin</a>
          <button id="btnDownload" class="btn">‚¨áÔ∏è Download</button>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input id="q" class="w-full p-2.5 rounded-xl border" placeholder="Search items, categories...">
        <select id="cat" class="p-2.5 rounded-xl border">
          <option value="All">All</option>
        </select>
        <button id="btnReset" class="btn">Reset</button>
      </div>
    </header>

    <!-- Pok√©mon for sale -->
    <section class="space-y-2">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><span class="brand font-bold">üßß Pok√©mon For Sale</span></div>
        <div class="flex items-center gap-2">
          <select id="pkOwner" class="p-2 rounded-lg border">
            <option value="All">All</option>
            <option value="Yerttty">Yerttty</option>
            <option value="Jonfiin">Jonfiin</option>
          </select>
          <input id="qPk" class="p-2 rounded-lg border" placeholder="Search Pok√©mon...">
        </div>
      </div>
      <div id="pkRows" class="list-grid"></div>
    </section>

    <!-- Items list -->
    <section class="space-y-2">
      <div class="flex items-center gap-2"><span class="brand font-bold">ü™Ñ Items</span>
        <small id="itemCount" class="text-slate-500"></small>
      </div>
      <div id="itemRows" class="space-y-6"></div>
    </section>
  </div>

  <!-- Requests modal -->
  <dialog id="dlg" class="rounded-2xl p-0 w-full max-w-3xl">
    <form method="dialog" class="p-4 sm:p-6 space-y-3">
      <div class="flex items-center justify-between">
        <div class="brand font-bold">Requests</div>
        <button class="btn">Close</button>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <input id="rqIGN" class="p-2 rounded-xl border" placeholder="IGN (in-game name)">
        <input id="rqDisco" class="p-2 rounded-xl border" placeholder="Discord handle">
        <select id="rqType" class="p-2 rounded-xl border col-span-2 sm:col-span-1">
          <option>Price check / Request new price</option>
          <option>Selling items</option>
          <option>Supplier info</option>
          <option>Other</option>
        </select>
        <input id="rqSubject" class="p-2 rounded-xl border sm:col-span-1 col-span-2" placeholder="Subject / item name (optional)">
      </div>

      <div class="space-y-1">
        <div class="text-xs text-slate-500">Add items you‚Äôre selling (totals use our current buy %)</div>
        <div class="flex items-center gap-2">
          <input id="rqQ" class="p-2 rounded-xl border w-full" placeholder="Search shop items‚Ä¶">
          <select id="rqCat" class="p-2 rounded-xl border"><option value="All">All categories</option></select>
        </div>
        <div id="rqItemPicker" class="grid grid-cols-2 lg:grid-cols-3 gap-2 max-h-72 overflow-auto p-1 rounded-xl border bg-white"></div>
        <div class="text-right text-sm">Estimated total: <b id="rqTotal">$0</b></div>
        <div id="rqSelected" class="text-sm text-slate-600"></div>
      </div>

      <textarea id="rqMsg" rows="4" class="w-full p-3 rounded-xl border" placeholder="Details / questions‚Ä¶"></textarea>

      <div class="flex items-center justify-end gap-2">
        <button class="btn" value="cancel">Close</button>
        <button id="rqSend" class="btn">Send</button>
      </div>
      <div class="text-xs text-slate-500">Submitted to Firebase ‚Üí <code>/shops/&lt;shopId&gt;/requests</code></div>
    </form>
  </dialog>

  <script>
    /***********************
     * Firebase (live)
     ***********************/
    const shopId = 'jjblossoms';
    const firebaseConfig = {
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    await auth.signInAnonymously();

    const BUY_RATE = 0.85;
    let items = [];     // {id,name,category,sellPrice,buyPrice,...}
    let pokemon = [];   // {owner,species,price,image?}

    const $ = (s)=>document.querySelector(s);

    const refItems = db.ref(`/shops/${shopId}/items`);
    const refPk    = db.ref(`/shops/${shopId}/pokemon`);
    const refReq   = db.ref(`/shops/${shopId}/requests`);

    refItems.on('value', snap=>{
      const v = snap.val() || {};
      items = Object.values(v).map(r=>({
        ...r,
        sellPrice: Number(r.sellPrice ?? r.price ?? 0),
        buyPrice:   Number(r.buyPrice ?? Math.round(Number(r.sellPrice ?? r.price ?? 0)*BUY_RATE))
      }));
      drawItems();
      buildRequestPicker();
    });

    refPk.on('value', snap=>{
      const v = snap.val() || {};
      pokemon = Object.values(v);
      drawPokemon();
    });

    /***********************
     * Items UI
     ***********************/
    function groupByCategory(list){
      const map = new Map();
      for(const it of list){
        const k = (it.category || 'Other').trim();
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }

    function drawItems(){
      const q = $('#q').value.toLowerCase();
      const cat = $('#cat').value || 'All';

      // fill cat dropdown once
      if($('#cat').options.length <= 1){
        const set = [...new Set(items.map(i=>i.category||'Other'))].sort((a,b)=>a.localeCompare(b));
        for(const c of set){ const o=document.createElement('option'); o.value=o.textContent=c; $('#cat').appendChild(o); }
      }

      const filtered = items.filter(it=>{
        const inCat = (cat==='All'||(it.category||'Other')===cat);
        const hit   = (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q);
        return inCat && hit;
      });

      $('#itemCount').textContent = `‚Äî ${filtered.length} items`;

      const byCat = groupByCategory(filtered);
      const wrap = $('#itemRows'); wrap.innerHTML = '';
      for(const [catName, rows] of byCat){
        const sec = document.createElement('div');
        sec.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="brand font-semibold">‚Ä¢ ${catName}</span>
              <small class="text-slate-400">${rows.length} items</small>
            </div>
          </div>`;
        const grid = document.createElement('div');
        grid.className = 'grid md:grid-cols-2 lg:grid-cols-3 gap-2';
        for(const r of rows){
          const buy = Math.round((r.sellPrice||0)*BUY_RATE);
          const el = document.createElement('div');
          el.className = 'card p-3';
          el.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium truncate">${r.name||''}</div>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
              <div class="chip">Our Price <b>$${Number(r.sellPrice||0).toFixed(0)}</b></div>
              <div class="chip">We Buy (85%) <b>$${buy.toFixed(0)}</b></div>
            </div>`;
          grid.appendChild(el);
        }
        sec.appendChild(grid);
        wrap.appendChild(sec);
      }
    }

    $('#q').addEventListener('input', drawItems);
    $('#cat').addEventListener('change', drawItems);
    $('#btnReset').addEventListener('click', ()=>{
      $('#q').value=''; $('#cat').value='All'; drawItems();
    });
    $('#btnReload').addEventListener('click', ()=>{ refItems.once('value'); refPk.once('value'); });

    /***********************
     * Pok√©mon UI (with image centered right & bigger)
     ***********************/
    function drawPokemon(){
      const owner = $('#pkOwner').value || 'All';
      const q = $('#qPk').value.toLowerCase();
      const list = pokemon.filter(p=>{
        if(owner!=='All' && p.owner!==owner) return false;
        const hay = [p.owner,p.species,p.nickname,p.nature,p.notes].map(s=>(s||'').toLowerCase()).join(' ');
        return hay.includes(q);
      });

      const box = $('#pkRows'); box.innerHTML='';
      for(const p of list){
        const img = p.image || p.imageUrl || p.img || '';
        const price = Number(p.price||0);

        const card = document.createElement('div');
        card.className = 'card p-3 pk-card';

        card.innerHTML = `
          <div class="pk-left">
            <div class="flex items-center justify-between">
              <div class="font-semibold truncate">${p.nickname?`${p.nickname} <span class="text-slate-400">(${p.species})</span>`: (p.species||'')}</div>
              <span class="pill">${p.owner||''}</span>
            </div>
            <div class="mt-1 flex flex-wrap items-center gap-2 text-xs">
              <span class="chip">$${price.toFixed(0)}</span>
              ${p.level?`<span class="chip">Lv ${p.level}</span>`:''}
              ${p.nature?`<span class="chip">${p.nature}</span>`:''}
              ${p.shiny?`<span class="chip">‚ú® Shiny</span>`:''}
            </div>
            <div class="mt-1 text-xs text-slate-600 space-x-2">
              ${p.tera?`<span class="pill">Tera: ${p.tera}</span>`:''}
              ${p.ball?`<span class="pill">Ball: ${p.ball}</span>`:''}
              ${p.ability?`<span class="pill">Ability: ${p.ability}</span>`:''}
              ${p.size?`<span class="pill">Size: ${p.size}</span>`:''}
            </div>
            ${p.ivs?`<div class="mt-1 text-[11px] text-slate-500">IVs ${p.ivs.hp||0}/${p.ivs.atk||0}/${p.ivs.def||0}/${p.ivs.spa||0}/${p.ivs.spd||0}/${p.ivs.spe||0}</div>`:''}
            ${p.evs?`<div class="text-[11px] text-slate-500">EVs ${p.evs.hp||0}/${p.evs.atk||0}/${p.evs.def||0}/${p.evs.spa||0}/${p.evs.spd||0}/${p.evs.spe||0}</div>`:''}
            ${p.moves?`<div class="mt-1 text-[11px] text-slate-600">Moves: ${p.moves}</div>`:''}
            ${p.notes?`<div class="mt-1 text-[11px] text-slate-600">${p.notes}</div>`:''}
          </div>
          ${img?`
            <div class="pk-img-box">
              <img src="${img}" alt="${p.species||'pokemon'}">
            </div>`:''}
        `;
        box.appendChild(card);
      }
    }

    $('#pkOwner').addEventListener('change', drawPokemon);
    $('#qPk').addEventListener('input', drawPokemon);

    /***********************
     * Requests modal
     ***********************/
    const dlg = $('#dlg');
    $('#btnReq').addEventListener('click', ()=> dlg.showModal());

    let rqPick = []; // {id,name,qty,price}
    function buildRequestPicker(){
      // cat dropdown
      const catSel = $('#rqCat');
      if(catSel.options.length <= 1){
        const set = [...new Set(items.map(i=>i.category||'Other'))].sort((a,b)=>a.localeCompare(b));
        for(const c of set){ catSel.add(new Option(c,c)); }
      }
      renderRqPicker();
    }

    function renderRqPicker(){
      const q = ($('#rqQ').value||'').toLowerCase();
      const cat = $('#rqCat').value || 'All';
      const grid = $('#rqItemPicker'); grid.innerHTML='';

      const pool = items.filter(it=>{
        const inCat = (cat==='All'||(it.category||'Other')===cat);
        const hit = (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q);
        return inCat && hit;
      }).slice(0,300);

      for(const it of pool){
        const id = it.id || (it.name+'|'+it.category);
        const buy = Number(it.buyPrice ?? Math.round((it.sellPrice||0)*BUY_RATE));
        const row = document.createElement('div');
        row.className = 'border rounded-xl p-2 text-xs';
        row.innerHTML = `
          <div class="font-medium truncate" title="${it.name}">${it.name}</div>
          <div class="text-[11px] text-slate-500">Our buy: $${buy}</div>
          <div class="mt-1 flex items-center gap-1">
            <button class="btn" data-dec="${id}">‚àí</button>
            <input class="w-12 p-1 rounded border text-center" data-qty="${id}" value="${getQty(id)}">
            <button class="btn" data-inc="${id}">+</button>
          </div>`;
        grid.appendChild(row);
      }

      // selected + total
      const selBox = $('#rqSelected');
      const total = rqPick.reduce((s,r)=> s + (r.qty*r.price), 0);
      $('#rqTotal').textContent = `$${total.toFixed(0)}`;
      selBox.textContent = rqPick.length
        ? rqPick.map(r=>`${r.name} √ó ${r.qty}`).join(', ')
        : 'Selected: ‚Äî';
    }

    function getQty(id){ return rqPick.find(x=>x.id===id)?.qty || 0; }
    function setQty(id,name,price,qty){
      qty = Math.max(0, Number(qty||0));
      const i = rqPick.findIndex(x=>x.id===id);
      if(i===-1 && qty>0) rqPick.push({id,name,price,qty});
      else if(i>-1){
        if(qty===0) rqPick.splice(i,1);
        else rqPick[i].qty = qty;
      }
      renderRqPicker();
    }

    $('#rqQ').addEventListener('input', renderRqPicker);
    $('#rqCat').addEventListener('change', renderRqPicker);
    $('#rqItemPicker').addEventListener('click', (e)=>{
      const t=e.target;
      const dec=t.getAttribute('data-dec');
      const inc=t.getAttribute('data-inc');
      if(dec||inc){
        const id = dec||inc;
        const it = items.find(x=> (x.id|| (x.name+'|'+x.category))===id);
        if(!it) return;
        const price = Number(it.buyPrice ?? Math.round((it.sellPrice||0)*BUY_RATE));
        const cur = getQty(id);
        setQty(id, it.name, price, cur + (inc?1:-1));
      }
    });
    $('#rqItemPicker').addEventListener('input', (e)=>{
      const id = e.target.getAttribute('data-qty'); if(!id) return;
      const it = items.find(x=> (x.id|| (x.name+'|'+x.category))===id); if(!it) return;
      const price = Number(it.buyPrice ?? Math.round((it.sellPrice||0)*BUY_RATE));
      setQty(id, it.name, price, e.target.value);
    });

    $('#rqSend').addEventListener('click', async (e)=>{
      e.preventDefault();
      const ign = $('#rqIGN').value.trim();
      const disco = $('#rqDisco').value.trim();
      const type = $('#rqType').value;
      const subject = $('#rqSubject').value.trim();
      const message = $('#rqMsg').value.trim();
      const total = rqPick.reduce((s,r)=> s + (r.qty*r.price), 0);

      const payload = {
        ts: Date.now(),
        status: 'open',
        ign, discord: disco, type, subject,
        message,
        items: rqPick.map(r=>({ id:r.id, name:r.name, qty:r.qty, price:r.price, line:r.qty*r.price })),
        total
      };
      try{
        await refReq.push(payload);
        // reset
        rqPick = []; $('#rqMsg').value=''; $('#rqSubject').value=''; $('#rqIGN').value=''; $('#rqDisco').value='';
        renderRqPicker();
        dlg.close();
        alert('Request sent ‚Äî we‚Äôll reach out on Discord.');
      }catch(err){
        console.error(err); alert('Failed to send.');
      }
    });

    /***********************
     * Download current items (password 44312)
     ***********************/
    function toCSV(rows){
      const header = ['name','category','sell','buy(85%)','stock','notes'];
      const lines = [header.join(',')];
      for(const r of rows){
        const sell = Number(r.sellPrice||0);
        const buy = Number(r.buyPrice ?? Math.round(sell*BUY_RATE));
        const vals = [
          `"${(r.name||'').replace(/"/g,'""')}"`,
          `"${(r.category||'').replace(/"/g,'""')}"`,
          sell,
          buy,
          (r.stock??''),
          `"${(r.notes||'').replace(/"/g,'""')}"`
        ];
        lines.push(vals.join(','));
      }
      return lines.join('\n');
    }

    $('#btnDownload').addEventListener('click', ()=>{
      const pw = prompt('Enter password to export CSV:');
      if(pw!=='44312') return alert('Wrong password.');
      const csv = toCSV(items);
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'shop.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
