<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#f6e6ee"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet"/>

  <!-- Firebase (compat so we can keep simple code) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .8rem;border-radius:.75rem;border:1px solid #e2e8f0;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .chip{font-size:.75rem;border:1px solid #e2e8f0;border-radius:999px;padding:.15rem .55rem;background:#fff}
    .card{border:1px solid #f1dbe6;border-radius:1rem;background:#fff}
    .cat-dot{width:.6rem;height:.6rem;border-radius:999px;background:#c084fc}
    .input{width:100%;padding:.55rem .75rem;border-radius:.75rem;border:1px solid #e2e8f0}
  </style>
</head>
<body class="bg-pink-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- Banner -->
    <div class="rounded-xl overflow-hidden shadow-sm mb-3">
      <img src="./Header.jpg" alt="Banner" class="w-full object-cover"/>
    </div>

    <!-- Title + toolbar -->
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <span class="text-pink-600">üå∏</span>
        <h1 class="brand text-2xl font-bold">JJBLOSSOMS <span class="text-sm font-normal ml-1 align-middle">SHOP</span></h1>
        <span id="sourceTag" class="chip ml-2">Data source: <b>Firebase (Live)</b></span>
      </div>
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="pokemonMenuBtn" class="btn">üß¨ Pok√©mon For Sale ‚ñæ</button>
          <div id="pokemonMenu" class="hidden absolute mt-2 w-44 bg-white border border-slate-200 rounded-xl shadow-lg z-50">
            <a href="#pokemon-Yerttty" class="block px-3 py-2 hover:bg-pink-50">Yerttty</a>
            <a href="#pokemon-Jonfiin" class="block px-3 py-2 hover:bg-pink-50">Jonfiin</a>
          </div>
        </div>
        <a href="./admin.html" class="btn">üëë Admin</a>
        <button id="reloadBtn" class="btn">üîÑ Reload data</button>
        <button id="downloadBtn" class="btn btn-primary">‚¨áÔ∏è Download CSV</button>
        <button id="reqBtn" class="btn">üßæ Requests</button>
      </div>
    </div>

    <!-- Search + filter -->
    <div class="mt-3 card p-3">
      <div class="flex flex-wrap gap-2 items-center">
        <input id="q" class="input flex-1" placeholder="Search items, categories..."/>
        <select id="cat" class="input w-44"></select>
        <button id="reset" class="btn">Reset</button>
      </div>
      <div class="text-xs text-slate-500 mt-2">Buy price = <span id="buyRateTag">85%</span> of item price (rounded).</div>
    </div>

    <!-- Items list -->
    <div id="itemsWrap" class="mt-4 space-y-6"></div>

    <!-- Pok√©mon sections -->
    <div id="pokemonWrap" class="mt-8 space-y-6"></div>
  </div>

  <!-- Requests modal -->
  <div id="reqModal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-xl w-full p-4">
      <div class="flex items-center justify-between">
        <h3 class="brand text-xl">Requests</h3>
        <button class="btn" id="reqClose">Close</button>
      </div>
      <p class="text-sm text-slate-600 mt-2">Tell us what you need ‚Äî price change, request a new item, or sell your items. We‚Äôll be notified.</p>

      <form id="reqForm" class="mt-3 space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input class="input" id="rIgn" placeholder="IGN (Minecraft username)" required/>
          <input class="input" id="rDiscord" placeholder="Discord (e.g. yerttty#1234)" required/>
        </div>

        <label class="text-sm font-semibold">Type</label>
        <select id="rType" class="input">
          <option value="price">Price check / request new price</option>
          <option value="new">Request NEW item</option>
          <option value="sell">Selling items to shop</option>
          <option value="other">Other question</option>
        </select>

        <!-- Selling list -->
        <div id="sellBox" class="hidden space-y-2">
          <div class="text-sm font-semibold">Add items you‚Äôre selling</div>
          <div class="flex gap-2">
            <select id="sellItem" class="input flex-1"></select>
            <input id="sellQty" type="number" min="1" class="input w-28" placeholder="Qty"/>
            <button id="sellAdd" type="button" class="btn">Add</button>
          </div>
          <div id="sellList" class="text-sm text-slate-700"></div>
          <div class="text-right text-sm font-semibold">Estimated total (buy price): $<span id="sellTotal">0</span></div>
        </div>

        <textarea id="rMsg" class="input" rows="4" placeholder="Details / notes"></textarea>
        <button class="btn btn-primary" type="submit">Send request</button>
      </form>
      <div id="reqToast" class="hidden mt-3 text-green-700 text-sm">Request sent ‚Äî thanks!</div>
    </div>
  </div>

  <script>
    /* ------------------ CONFIG ------------------ */
    const SHOP_ID = 'jjblossoms';
    const BUY_RATE = 0.85; // shown in UI
    const PASSWORD = '44312'; // gate for CSV download

    const firebaseConfig = {
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };

    /* ------------------ STATE ------------------ */
    let app, db, auth;
    let items = [];            // [{id,name,category,price,buy,stock,notes}]
    let pokemon = [];          // [{owner,species,...}]
    let categories = [];       // unique category list

    const $ = (s)=>document.querySelector(s);

    /* ------------------ INIT ------------------ */
    async function connect() {
      try {
        app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        await auth.signInAnonymously();
        db = firebase.database();
        $('#sourceTag').innerHTML = 'Data source: <b>Firebase (Live)</b>';
        $('#buyRateTag').textContent = Math.round(BUY_RATE*100)+'%';
        await loadAll();
      } catch (e) {
        console.error(e);
        $('#sourceTag').innerHTML = 'Data source: <b>CSV</b>';
      }
    }

    async function loadAll() {
      const snap = await db.ref(`/shops/${SHOP_ID}/items`).get();
      const raw = snap.val() || {};
      items = Object.values(raw).map(it=>{
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        return {
          id: it.id || (it.name+'|'+(it.category||'')),
          name: it.name || '',
          category: it.category || '',
          price: Math.round(sell),
          buy: Math.round(sell * BUY_RATE),
          stock: it.stock === '' || it.stock == null ? '' : Number(it.stock),
          notes: it.notes || ''
        };
      }).sort((a,b)=> (a.category||'').localeCompare(b.category||'') || a.name.localeCompare(b.name));

      categories = [...new Set(items.map(i=>i.category).filter(Boolean))].sort();
      fillFilters();
      renderItems();

      const ps = await db.ref(`/shops/${SHOP_ID}/pokemon`).get();
      pokemon = Object.values(ps.val() || {});
      renderPokemon();
      fillRequestSellOptions();
    }

    /* ------------------ RENDER: ITEMS ------------------ */
    function fillFilters(){
      const sel = $('#cat');
      const cur = sel.value || 'All';
      sel.innerHTML = '';
      sel.add(new Option('All','All'));
      categories.forEach(c => sel.add(new Option(c,c)));
      if(items.some(i=>!i.category)) sel.add(new Option('Other','Other'));
      sel.value = [...sel.options].some(o=>o.value===cur) ? cur : 'All';
    }

    function renderItems(){
      const q = $('#q').value.trim().toLowerCase();
      const cat = $('#cat').value || 'All';
      const wrap = $('#itemsWrap');
      wrap.innerHTML = '';

      // group by category
      const groups = {};
      for(const it of items){
        if(cat!=='All' && !(cat==='Other' ? !it.category : it.category===cat)) continue;
        if(q && !((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q))) continue;
        const key = it.category || 'Other';
        (groups[key] ||= []).push(it);
      }

      Object.keys(groups).sort().forEach(catName=>{
        const list = groups[catName];

        const sec = document.createElement('section');
        sec.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="cat-dot"></span>
              <div class="brand font-bold uppercase tracking-wide text-sm">${catName}</div>
              <span class="text-[11px] text-slate-500">${list.length} items</span>
            </div>
          </div>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        `;
        const grid = sec.querySelector('div.grid');

        list.forEach(it=>{
          const card = document.createElement('div');
          card.className = 'card p-3';
          card.innerHTML = `
            <div class="font-semibold">${it.name}</div>
            <div class="mt-2 flex items-center justify-between">
              <div class="chip">Our Price <b>$${it.price.toFixed(0)}</b></div>
              <div class="chip">We Buy For (${Math.round(BUY_RATE*100)}%) <b>$${it.buy.toFixed(0)}</b></div>
            </div>
            ${it.notes ? `<div class="mt-2 text-xs text-slate-600">${it.notes}</div>`:''}
          `;
          grid.appendChild(card);
        });

        wrap.appendChild(sec);
      });
    }

    /* ------------------ RENDER: POK√âMON ------------------ */
    function renderPokemon(){
      const wrap = $('#pokemonWrap');
      wrap.innerHTML = '';

      const owners = ['Yerttty','Jonfiin'];
      owners.forEach(owner=>{
        const list = pokemon.filter(p=> (p.owner||'')===owner);
        const sec = document.createElement('section');
        sec.id = `pokemon-${owner}`;
        sec.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="brand font-bold">${owner} ‚Äî Pok√©mon For Sale</div>
            <span class="text-[11px] text-slate-500">${list.length} listed</span>
          </div>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        `;
        const grid = sec.querySelector('div.grid');

        list.forEach(p=>{
          const card = document.createElement('div');
          card.className = 'card p-3';
          const flags = [p.shiny?'‚ú® Shiny':null, p.neutered?'Neutered':null].filter(Boolean).join(' ¬∑ ');
          card.innerHTML = `
            <div class="font-semibold">${p.nickname ? `${p.nickname} (${p.species})` : p.species}</div>
            <div class="text-xs text-slate-500">${p.nature||''} ‚Ä¢ Lv ${p.level||'?'} ${flags?`‚Ä¢ ${flags}`:''}</div>
            <div class="mt-2 chip">Price <b>$${Number(p.price||0).toFixed(0)}</b></div>
            ${p.notes ? `<div class="mt-2 text-xs text-slate-600">${p.notes}</div>`:''}
          `;
          grid.appendChild(card);
        });

        wrap.appendChild(sec);
      });
    }

    /* ------------------ REQUESTS ------------------ */
    function openReq(show){
      $('#reqModal').classList.toggle('hidden', !show);
      if(show){ $('#reqToast').classList.add('hidden'); }
    }
    $('#reqBtn').addEventListener('click', ()=> openReq(true));
    $('#reqClose').addEventListener('click', ()=> openReq(false));
    $('#rType').addEventListener('change', e=>{
      $('#sellBox').classList.toggle('hidden', e.target.value!=='sell');
    });

    const sellCart = [];
    function fillRequestSellOptions(){
      const sel = $('#sellItem'); sel.innerHTML='';
      items.forEach(it=> sel.add(new Option(`${it.name} ‚Äî ${it.category}`, it.id)));
    }
    $('#sellAdd').addEventListener('click', ()=>{
      const id = $('#sellItem').value;
      const qty = Math.max(1, Number($('#sellQty').value||1));
      const it = items.find(x=>x.id===id);
      if(!it) return;
      const entry = {id, name: it.name, buy: it.buy, qty};
      sellCart.push(entry);
      renderSellCart();
    });
    function renderSellCart(){
      const box = $('#sellList');
      box.innerHTML = sellCart.map(s=>`<div>√ó${s.qty} ‚Äî ${s.name} @ $${s.buy} each</div>`).join('') || '<div class="text-slate-400">No items yet</div>';
      const total = sellCart.reduce((t,s)=> t + (s.buy * s.qty), 0);
      $('#sellTotal').textContent = total.toFixed(0);
    }

    $('#reqForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!db){ alert('Not connected to Firebase.'); return; }
      const payload = {
        ign: $('#rIgn').value.trim(),
        discord: $('#rDiscord').value.trim(),
        type: $('#rType').value,
        msg: $('#rMsg').value.trim(),
        sell: sellCart.slice(),
        _ts: Date.now()
      };
      try{
        await db.ref(`/shops/${SHOP_ID}/requests`).push(payload);
        $('#reqToast').classList.remove('hidden');
        e.target.reset();
        sellCart.length = 0; renderSellCart();
      }catch(err){
        console.error(err); alert('Failed to send request.');
      }
    });

    /* ------------------ DOWNLOAD CSV ------------------ */
    function toCsv(rows){
      return rows.map(r => r.map(v=>{
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
    }

    function buildExportRows(){
      const headers = ['Name','Category','Sell','Buy(85%)','Stock','Notes'];
      const rows = items.map(it => [
        it.name, it.category, Math.round(it.price||0), Math.round(it.buy||0),
        (it.stock===''||it.stock==null)?'':Number(it.stock), it.notes||''
      ]);
      return [headers, ...rows];
    }

    function downloadCsv(){
      const pass = prompt('Enter password to export CSV:');
      if(pass !== PASSWORD){ alert('Wrong password.'); return; }

      const rows = buildExportRows();
      const csv = toCsv(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `shop_export_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* ------------------ UI EVENTS ------------------ */
    $('#pokemonMenuBtn').addEventListener('click', ()=>{
      $('#pokemonMenu').classList.toggle('hidden');
    });
    document.addEventListener('click', (e)=>{
      if(!$('#pokemonMenuBtn').contains(e.target) && !$('#pokemonMenu').contains(e.target)){
        $('#pokemonMenu').classList.add('hidden');
      }
    });

    $('#q').addEventListener('input', renderItems);
    $('#cat').addEventListener('change', renderItems);
    $('#reset').addEventListener('click', ()=>{
      $('#q').value=''; $('#cat').value='All'; renderItems();
    });
    $('#reloadBtn').addEventListener('click', loadAll);
    $('#downloadBtn').addEventListener('click', downloadCsv);

    /* ------------------ BOOT ------------------ */
    connect();
  </script>
</body>
</html>
