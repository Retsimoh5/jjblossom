<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#fce7f3"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --brand:#be185d }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #e5e7eb; background:#fff }
    .card{ border:1px solid #f1d5df; border-radius:1rem; background:#fff8fb }
    .pill{ font-size:.75rem; padding:.15rem .45rem; border-radius:.5rem; background:#ffe4ed }
    .menu{ position:relative }
    .menu > .menu-panel{ position:absolute; z-index:50; top:100%; left:0; min-width:12rem; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem; display:none; box-shadow:0 10px 20px rgba(0,0,0,.08) }
    .menu.open > .menu-panel{ display:block }
    .section-title{ font-weight:800; letter-spacing:.02em; }
    .grid-items{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:.75rem }
  </style>
</head>
<body class="bg-gradient-to-b from-rose-50 to-pink-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="space-y-3">
      <img src="./Header.jpg" alt="JJBlossoms header" class="w-full h-40 object-cover rounded-2xl shadow" onerror="this.style.display='none'">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms <span class="text-xs align-middle font-normal">SHOP</span></span>
          <div class="menu">
            <button id="pkMenuBtn" class="btn">üé¥ Pok√©mon For Sale ‚ñæ</button>
            <div class="menu-panel" id="pkMenu">
              <a href="#view=pokemon&owner=Yerttty" class="block px-2 py-1 rounded hover:bg-rose-50">Yerttty</a>
              <a href="#view=pokemon&owner=Jonfiin" class="block px-2 py-1 rounded hover:bg-rose-50">Jonfiin</a>
              <a href="#view=pokemon" class="block px-2 py-1 rounded hover:bg-rose-50">All Pok√©mon</a>
              <div class="border-t my-1"></div>
              <a href="./admin.html" class="block px-2 py-1 rounded hover:bg-rose-50">üîß Admin</a>
            </div>
          </div>
          <a href="./" class="btn">üè† Home</a>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnReload" class="btn">üîÑ Reload data</button>
          <button id="btnRequests" class="btn">üì® Requests</button>
        </div>
      </div>
      <p class="text-xs text-slate-600">Data source: <span id="dataSource">CSV</span> ‚Äî Buy price = 85% of item price (rounded).</p>
    </header>

    <section class="card p-3">
      <div class="flex flex-col sm:flex-row gap-2 items-center">
        <input id="q" class="w-full px-3 py-2 rounded-lg border border-rose-200" placeholder="Search items, categories...">
        <div class="flex items-center gap-2">
          <select id="cat" class="px-3 py-2 rounded-lg border border-rose-200"></select>
          <button id="reset" class="btn">Reset</button>
        </div>
      </div>
    </section>

    <div id="content"></div>

    <footer class="text-center text-xs text-rose-900/80 mt-8">üå∏ JJBlossoms ‚Äî where Mewtwo shops for deals</footer>
  </div>

  <dialog id="reqDlg" class="rounded-xl p-0 w-[min(92vw,34rem)]">
    <form method="dialog" class="p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div class="brand font-bold">Requests</div>
        <button class="btn">‚úñ</button>
      </div>
      <div id="reqBody" class="text-sm text-slate-700 leading-relaxed"></div>
    </form>
  </dialog>

<script>
const BUY=0.85, LS='jjb_admin_cfg_v2';
let app, db, auth, refItems, refPk;
let items=[], pokemon=[];
const $=(s)=>document.querySelector(s);
function parseHash(){ const h=new URLSearchParams(location.hash.replace(/^#/,'')); return { view:h.get('view')||'items', owner:h.get('owner')||'All' }; }
function idify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

// Menu
document.addEventListener('click',(e)=>{
  if(e.target.id==='pkMenuBtn'){ document.querySelector('.menu').classList.toggle('open'); }
  else if(!e.target.closest('.menu')){ document.querySelector('.menu').classList.remove('open'); }
});

function loadCfg(){ try{return JSON.parse(localStorage.getItem(LS)||'{}');}catch{return{}} }
async function connectIfPossible(){
  const cfg=loadCfg(); const shopId=(cfg.shopId||'').trim();
  if(!cfg.cfg || !shopId) { document.getElementById('dataSource').textContent='CSV'; return false; }
  try{
    app = firebase.apps.length? firebase.app(): firebase.initializeApp(cfg.cfg);
    auth = firebase.auth(); await auth.signInAnonymously();
    db = firebase.database();
    refItems = db.ref('/shops/'+shopId+'/items');
    refPk = db.ref('/shops/'+shopId+'/pokemon');
    document.getElementById('dataSource').textContent='Firebase (Live)';
    refItems.on('value', snap=>{ const v=snap.val()||{}; items = Object.values(v); render(); });
    refPk.on('value', snap=>{ const v=snap.val()||{}; pokemon = Object.values(v); render(); });
    return true;
  }catch(e){ console.error(e); document.getElementById('dataSource').textContent='CSV (fallback)'; return false; }
}

async function loadCsv(){
  try{
    const res=await fetch('shop.csv',{cache:'no-store'});
    if(!res.ok) return;
    const text=await res.text();
    const wb=XLSX.read(text,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
    const headers=(rows[0]||[]).map(x=>String(x||'').toLowerCase());
    const idxName=headers.findIndex(h=>h.includes('name')||h==='item');
    const idxCat =headers.findIndex(h=>h.includes('cat'));
    const idxPrice=headers.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
    const idxNotes=headers.findIndex(h=>h.includes('notes')||h.includes('desc'));
    const body=rows.slice(1);
    items = body.map((r,i)=>{
      const name=String(r[idxName]||'').trim(); if(!name) return null;
      const category=String(r[idxCat]||'').trim();
      const sell=Number(r[idxPrice]||0);
      const notes=String(r[idxNotes]||'').trim();
      return { id:idify(name+'-'+category+'-'+i), name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY), notes };
    }).filter(Boolean);
  }catch(e){ console.error(e); }
}

function groupByCat(list){ const m=new Map(); for(const it of list){ const c=it.category||'Other'; if(!m.has(c)) m.set(c,[]); m.get(c).push(it);} return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0])); }

function renderItems(){
  const q=document.getElementById('q').value.toLowerCase();
  const catSel=document.getElementById('cat').value||'All';
  const filtered = items.filter(it=> (catSel==='All'||it.category===catSel) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)) );
  const groups = groupByCat(filtered);
  const wrap=document.createElement('div');
  for(const [cat, list] of groups){
    const sec=document.createElement('section'); sec.className='space-y-2 mt-4';
    sec.innerHTML=\`<div class="text-xs uppercase tracking-wider section-title text-rose-900/80">\${cat}</div><div class="grid-items"></div>\`;
    const grid=sec.querySelector('.grid-items');
    list.forEach(it=>{
      const card=document.createElement('div'); card.className='card p-3';
      const price=Number(it.sellPrice??it.price??0);
      card.innerHTML=\`<div class="font-semibold">\${it.name}</div>
        <div class="mt-2 flex items-center gap-2">
          <span class="pill">Our Price<br><b>$\${price.toFixed(0)}</b></span>
          <span class="pill">We Buy For (85%)<br><b>$\${Math.round(price*BUY)}</b></span>
        </div>\`;
      grid.appendChild(card);
    });
    wrap.appendChild(sec);
  }
  const content=document.getElementById('content'); content.innerHTML=''; content.appendChild(wrap);
  const cats=[...new Set(items.map(i=>i.category).filter(Boolean))].sort();
  const sel=document.getElementById('cat'); sel.innerHTML=''; sel.add(new Option('All','All')); cats.forEach(c=> sel.add(new Option(c,c)));
}

function renderPokemon(){
  const params=parseHash(); const owner=params.owner;
  const q=document.getElementById('q').value.toLowerCase();
  const list = pokemon.filter(p=>(owner==='All'||p.owner===owner) && ((p.species||'').toLowerCase().includes(q)||(p.nickname||'').toLowerCase().includes(q)||(p.nature||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)));
  const wrap=document.createElement('div'); const grid=document.createElement('div'); grid.className='grid-items'; wrap.appendChild(grid);
  for(const p of list){
    const flags=[p.shiny?'‚ú® Shiny':null,p.neutered?'Neutered':null].filter(Boolean).join(' ¬∑ ');
    const card=document.createElement('div'); card.className='card p-3';
    card.innerHTML=\`<div class="flex items-center justify-between">
        <div class="font-semibold">\${p.nickname?`\${p.nickname} (\${p.species})`:p.species}</div>
        <span class="text-sm font-bold text-rose-900">$\${Number(p.price||0).toFixed(0)}</span>
      </div>
      <div class="text-xs mt-1 text-slate-700">\${p.owner}\${flags?' ‚Äî '+flags:''}</div>
      <div class="text-xs mt-1 text-slate-700">Lv \${p.level||'?'} ‚Ä¢ \${p.nature||''}</div>
      \${p.moves?`<div class="text-xs mt-1 text-slate-700">Moves: \${p.moves}</div>`:''}
      \${p.notes?`<div class="text-xs mt-1 text-slate-700">\${p.notes}</div>`:''}\`;
    grid.appendChild(card);
  }
  const content=document.getElementById('content'); content.innerHTML=''; content.appendChild(wrap);
}

function render(){ const view=parseHash().view; if(view==='pokemon') renderPokemon(); else renderItems(); }

document.getElementById('btnRequests').addEventListener('click', ()=>{
  const cfg=loadCfg(); const live = !!cfg.cfg && !!cfg.shopId;
  document.getElementById('reqBody').textContent = live
    ? 'Requests are enabled. Use the admin page to review them.'
    : 'Requests will be enabled after Firebase is connected. For now, DM Yerttty or Jonfiin on Discord to request price changes, items, or supplier info.';
  document.getElementById('reqDlg').showModal();
});
document.getElementById('q').addEventListener('input', render);
document.getElementById('cat').addEventListener('change', render);
document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('cat').value='All'; render(); });
document.getElementById('btnReload').addEventListener('click', ()=>{ location.reload(); });
window.addEventListener('hashchange', render);

(async()=>{
  const connected = await connectIfPossible();
  if(!connected){ await loadCsv(); }
  render();
})();
</script>
</body>
</html>
