<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Shop (Live)</title>
  <meta name="theme-color" content="#f7ddea"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <!-- Firebase (compat so we can keep code simple) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:.25rem;padding:.15rem .5rem;border-radius:9999px;background:#f1f5f9;border:1px solid #e2e8f0;font-size:12px}
    .input{width:100%;padding:.55rem .75rem;border:1px solid #cbd5e1;border-radius:.75rem}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
  </style>
</head>
<body class="bg-rose-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-3">
        <img src="./Header.jpg" class="h-20 rounded-xl object-cover" alt="">
        <div>
          <h1 class="brand text-2xl font-bold">üå∏ JJBlossoms <span class="text-sm align-middle chip">Data source: Firebase (Live)</span></h1>
          <div class="text-xs text-slate-500">Buy price = % of item price (rounded).</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnDownload" class="btn">‚¨áÔ∏è Download CSV</button>
        <button id="btnAdmin" class="btn">üõ†Ô∏è Admin</button>
        <button id="btnReload" class="btn">üîÑ Reload data</button>
        <button id="btnRequests" class="btn relative">üì® Requests</button>
      </div>
    </header>

    <!-- Pok√©mon for sale preview (kept simple: first few) -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Pok√©mon For Sale</h2>
        <input id="qPk" class="input max-w-xs" placeholder="Search Pok√©mon‚Ä¶">
      </div>
      <div id="pkGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <!-- Items (cards) -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="brand text-xl">Items</h2>
        <div class="flex items-center gap-2">
          <input id="qItems" class="input" placeholder="Search items, categories‚Ä¶">
          <select id="catItems" class="input"></select>
        </div>
      </div>
      <div id="itemsWrap" class="space-y-6"></div>
    </section>
  </div>

  <!-- Request Modal -->
  <dialog id="dlgReq" class="w-[min(960px,95vw)] rounded-2xl border p-0">
    <form method="dialog" class="p-0 m-0">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="brand font-bold text-lg">Requests</div>
        <button class="btn" value="cancel">Close</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input id="rqIGN"  class="input" placeholder="IGN (in-game name)">
          <input id="rqDisc" class="input" placeholder="Discord handle">
          <select id="rqType" class="input">
            <option value="price-check">Price check / Request new price</option>
            <option value="selling-items">Selling items</option>
            <option value="other">Other / question</option>
          </select>
          <input id="rqSubject" class="input" placeholder="Subject / item name (optional)">
        </div>

        <div class="text-xs text-slate-500">Add items you're selling (uses our current buy %):</div>
        <div class="flex items-center gap-2">
          <input id="rqSearch" class="input" placeholder="Search shop items‚Ä¶" />
          <select id="rqCat" class="input max-w-[220px]"></select>
        </div>

        <div id="rqItems" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>

        <div>
          <div class="text-xs text-slate-500">Selected</div>
          <div id="rqSelected" class="text-sm p-2 border rounded-lg bg-slate-50 min-h-[2rem]"></div>
          <div class="text-right text-sm mt-1">Estimated total: <b id="rqTotal">$0</b></div>
        </div>

        <textarea id="rqMsg" class="input h-28" placeholder="Details / questions‚Ä¶"></textarea>
        <div class="text-xs text-slate-500">Submitted to Firebase ‚Üí <code>/shops/&lt;shop&gt;/requests</code></div>
      </div>
      <div class="p-4 border-t flex items-center justify-end gap-2">
        <button class="btn" value="cancel">Close</button>
        <button id="rqSend" class="btn">Send</button>
      </div>
    </form>
  </dialog>

  <script>
    /***********************
     * Firebase connection *
     ***********************/
    const SHOP_ID = 'jjblossoms';  // <- your shop id
    const FB = {
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };
    const app  = firebase.initializeApp(FB);
    const db   = firebase.database();
    const refItems = db.ref(`/shops/${SHOP_ID}/items`);
    const refPk    = db.ref(`/shops/${SHOP_ID}/pokemon`);
    const refReq   = db.ref(`/shops/${SHOP_ID}/requests`);

    /****************
     * Local state  *
     ****************/
    let ITEMS = [];  // {id,name,category,sellPrice,buyPrice,...}
    let POKES = [];
    const BUY_RATE = 0.85; // fallback if item.buyPrice missing

    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const asMoney = n => '$' + Math.round(Number(n||0)).toLocaleString();

    /**********************
     * Render ‚Äì Pok√©mon   *
     **********************/
    function renderPokemon(){
      const q = ($('#qPk').value||'').toLowerCase();
      const hit = POKES.filter(p =>
        (p.species||'').toLowerCase().includes(q) ||
        (p.nickname||'').toLowerCase().includes(q) ||
        (p.nature||'').toLowerCase().includes(q)
      ).slice(0,12);
      const host = $('#pkGrid'); host.innerHTML='';
      hit.forEach(p=>{
        const div=document.createElement('div');
        div.className='p-3 rounded-xl border bg-white';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${p.nickname?`${p.nickname} (${p.species})`:p.species}</div>
            <div class="chip">${asMoney(p.price)}</div>
          </div>
          <div class="text-xs text-slate-600 mt-1">Lv ${p.level||1} ‚Äî ${p.nature||''} ${p.shiny?'‚Ä¢ ‚ú®Shiny':''}</div>
          ${p.img ? `<img src="${p.img}" class="mt-2 h-28 w-full object-contain">` : ''}
          ${p.notes? `<div class="mt-2 text-xs text-slate-600">${p.notes}</div>`:''}
        `;
        host.appendChild(div);
      });
    }

    /**********************
     * Render ‚Äì Items     *
     **********************/
    function fillItemCats(){
      const set = new Set(ITEMS.map(i=>i.category).filter(Boolean));
      const sel = $('#catItems'); const cur=sel.value;
      sel.innerHTML = `<option value="All">All</option>` + [...set].sort((a,b)=>a.localeCompare(b)).map(c=>`<option>${c}</option>`).join('');
      if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
    }

    function renderItems(){
      const q  = ($('#qItems').value||'').toLowerCase();
      const cat= $('#catItems').value||'All';
      const groups = new Map();
      ITEMS.forEach(it=>{
        if(cat!=='All' && it.category!==cat) return;
        const ok = (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q);
        if(!ok) return;
        const g = it.category||'Other';
        if(!groups.has(g)) groups.set(g, []);
        groups.get(g).push(it);
      });

      const wrap = $('#itemsWrap'); wrap.innerHTML='';
      [...groups.keys()].sort((a,b)=>a.localeCompare(b)).forEach(g=>{
        const items = groups.get(g).sort((a,b)=>a.name.localeCompare(b.name));
        const sec = document.createElement('div');
        sec.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <img src="./4.png" class="h-4 w-4"> <!-- your little sprite -->
              <h3 class="brand font-semibold">${g}</h3>
              <span class="text-xs text-slate-500">${items.length} items</span>
            </div>
          </div>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
        `;
        const grid = sec.querySelector('div.grid');
        items.forEach(it=>{
          const div=document.createElement('div');
          div.className='p-3 rounded-xl border bg-white';
          const buy = Number(it.buyPrice ?? Math.round(Number(it.sellPrice||0)*BUY_RATE));
          div.innerHTML = `
            <div class="font-semibold">${it.name}</div>
            <div class="text-xs text-slate-600">${it.category||''}</div>
            <div class="mt-2 flex items-center gap-2 text-xs">
              <span class="chip">Our Price ${asMoney(it.sellPrice)}</span>
              <span class="chip">We Buy For ${asMoney(buy)}</span>
            </div>
          `;
          grid.appendChild(div);
        });
        wrap.appendChild(sec);
      });
    }

    /*************************
     * Requests ‚Äì UI wiring  *
     *************************/
    const dlg = $('#dlgReq');
    $('#btnRequests').addEventListener('click', ()=>{
      if(!dlg.open) dlg.showModal();
    });

    // Build request picker from ITEMS
    function renderReqPicker(){
      // fill category filter
      const set = new Set(ITEMS.map(i=>i.category).filter(Boolean));
      const sel = $('#rqCat'); sel.innerHTML = `<option value="All">All categories</option>` + [...set].sort((a,b)=>a.localeCompare(b)).map(c=>`<option>${c}</option>`).join('');
      // render list
      doRenderReqItems();
    }

    function doRenderReqItems(){
      const q  = ($('#rqSearch').value||'').toLowerCase();
      const cat= $('#rqCat').value||'All';
      const host = $('#rqItems'); host.innerHTML='';
      const list = ITEMS.filter(it => (cat==='All'||it.category===cat) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q))).slice(0,90);
      list.forEach(it=>{
        const buy = Number(it.buyPrice ?? Math.round(Number(it.sellPrice||0)*BUY_RATE));
        const id  = it.id;
        const row = document.createElement('div');
        row.className = 'p-2 rounded-lg border bg-white flex items-center justify-between gap-2';
        row.innerHTML = `
          <div>
            <div class="font-medium">${it.name}</div>
            <div class="text-[11px] text-slate-500">${it.category||''} ‚Ä¢ Our buy: ${asMoney(buy)}</div>
          </div>
          <div class="flex items-center gap-1">
            <button class="px-2 py-1 border rounded-lg" data-dec="${id}">‚àí</button>
            <input class="w-12 text-center border rounded-lg p-1" value="0" data-qty="${id}">
            <button class="px-2 py-1 border rounded-lg" data-inc="${id}">+</button>
          </div>
        `;
        host.appendChild(row);
      });
      updateSelectedSummary();
    }

    function updateSelectedSummary(){
      const qInputs = $$('#rqItems [data-qty]');
      const lines = [];
      let total = 0;
      qInputs.forEach(inp=>{
        const id = inp.getAttribute('data-qty');
        const qty = Math.max(0, Number(inp.value||0));
        if(!qty) return;
        const it = ITEMS.find(x=>x.id===id);
        if(!it) return;
        const unit = Number(it.buyPrice ?? Math.round(Number(it.sellPrice||0)*BUY_RATE));
        const line = unit * qty;
        total += line;
        lines.push({ id: it.id, name: it.name, qty, unit, line });
      });
      // show
      $('#rqSelected').innerHTML = lines.length
        ? lines.map(l=>`${l.name} √ó ${l.qty} @ ${asMoney(l.unit)} = <b>${asMoney(l.line)}</b>`).join('<br>')
        : `<span class="text-slate-400">No items selected‚Ä¶</span>`;
      $('#rqTotal').textContent = asMoney(total);
      // stash for send
      $('#rqSelected').dataset.payload = JSON.stringify({ lines, total });
    }

    // qty step buttons
    document.addEventListener('click', (e)=>{
      const inc = e.target.getAttribute('data-inc');
      const dec = e.target.getAttribute('data-dec');
      if(inc || dec){
        const id = inc || dec;
        const box = document.querySelector(`[data-qty="${id}"]`);
        let v = Math.max(0, Number(box.value||0));
        v += inc ? 1 : (v>0?-1:0);
        box.value = v;
        updateSelectedSummary();
      }
    });
    document.addEventListener('input', (e)=>{
      if(e.target.matches('#rqItems [data-qty]')) updateSelectedSummary();
      if(e.target.matches('#rqSearch') || e.target.matches('#rqCat')) doRenderReqItems();
      if(e.target.matches('#qPk')) renderPokemon();
      if(e.target.matches('#qItems')) renderItems();
      if(e.target.matches('#catItems')) renderItems();
    });

    // SEND
    $('#rqSend').addEventListener('click', async (e)=>{
      e.preventDefault();
      const ign = $('#rqIGN').value.trim();
      const discord = $('#rqDisc').value.trim();
      const type = $('#rqType').value;
      const subject = $('#rqSubject').value.trim();
      const message = $('#rqMsg').value.trim();
      const { lines=[], total=0 } = JSON.parse($('#rqSelected').dataset.payload || '{"lines":[],"total":0}');
      const payload = {
        ts: Date.now(),
        status: 'open',
        ign, discord, type, subject,
        message,
        items: lines,       // [{id,name,qty,unit,line}]
        total
      };
      try{
        await refReq.push(payload);
        // reset a few fields
        $('#rqMsg').value='';
        $$('[data-qty]').forEach(x=>x.value=0);
        updateSelectedSummary();
        dlg.close();
        alert('Request sent ‚Äî we will reach out on Discord!');
      }catch(err){
        console.error(err);
        alert('Failed to send request.');
      }
    });

    /*************************
     * Download CSV (password)
     *************************/
    $('#btnDownload').addEventListener('click', async ()=>{
      const pw = prompt('Enter password to export CSV:');
      if(pw !== '44312') return alert('Wrong password.');
      const snap = await refItems.get(); const obj = snap.val()||{};
      const rows = [['name','category','sell_price','buy_price','stock','notes']];
      Object.values(obj).forEach(it=>{
        rows.push([it.name||'', it.category||'', it.sellPrice||0, (it.buyPrice??Math.round((it.sellPrice||0)*BUY_RATE)), it.stock===''?'':it.stock, it.notes||'']);
      });
      const csv = rows.map(r => r.map(v=>{
        v = (v===null||v===undefined)?'':String(v);
        return /[,"\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'shop.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Admin button
    $('#btnAdmin').addEventListener('click', ()=> location.href='admin.html');

    /*************************
     * Live data listeners   *
     *************************/
    refItems.on('value', snap=>{
      const v = snap.val() || {};
      ITEMS = Object.values(v).sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
      fillItemCats(); renderItems(); renderReqPicker();
    });
    refPk.on('value', snap=>{
      const v = snap.val() || {};
      POKES = Object.values(v);
      renderPokemon();
    });

    // open requests dialog renders picker first time
    $('#btnRequests').addEventListener('click', renderReqPicker);
  </script>
</body>
</html>
