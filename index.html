<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#f4e1e8"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (Compat for simplicity with your current Admin) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    :root{
      --rose:#f4e1e8;
      --ink:#0f172a;
      --muted:#64748b;
      --ring:#e2e8f0;
      --chip:#f8fafc;
    }
    body{ background:var(--rose) }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .btn{ display:inline-flex; align-items:center; gap:.45rem; padding:.5rem .8rem; border:1px solid var(--ring); border-radius:.75rem; background:#fff }
    .btn-ghost{ background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid var(--ring); border-radius:1rem; background:#fff }
    .chip{ background:var(--chip); border:1px solid var(--ring); border-radius:.5rem; padding:.15rem .45rem; font-size:.75rem }
    .poke-grid{ display:grid; grid-template-columns: 1fr minmax(220px, 320px); gap:1rem }
    @media (max-width: 900px){ .poke-grid{ grid-template-columns: 1fr } }
    .img-wrap{
      aspect-ratio: 1.2 / 1;
      border:1px solid var(--ring);
      border-radius:.75rem;
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .img-wrap img{ width:100%; height:100%; object-fit:contain }
    .hstack{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 pb-16">
    <!-- Banner -->
    <div class="mt-6 mb-2">
      <img src="./Header.jpg" class="w-full rounded-2xl border border-[var(--ring)]" alt="Header">
    </div>

    <!-- Top bar -->
    <div class="flex items-center justify-between gap-2 flex-wrap mb-3">
      <div class="brand text-xl sm:text-2xl font-bold flex items-center gap-2">
        üå∏ JJBlossoms <span class="text-xs font-normal text-[var(--muted)]">Data source: Firebase (Live)</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnPokemon" class="btn btn-ghost">üß¨ Pok√©mon For Sale</button>
        <button id="btnDownload" class="btn btn-ghost">‚¨áÔ∏è Download</button>
        <a href="./admin.html" class="btn btn-ghost">üõ†Ô∏è Admin</a>
        <button id="btnReload" class="btn btn-ghost">üîÑ Reload data</button>
        <button id="btnRequest" class="btn btn-ghost">üìÆ Requests</button>
      </div>
    </div>

    <!-- Pok√©mon for sale -->
    <section class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="hstack">
          <select id="pkOwnerFilter" class="btn-ghost btn">
            <option value="All">All</option>
            <option value="Yerttty">Yerttty</option>
            <option value="Jonfiin">Jonfiin</option>
          </select>
          <input id="qPk" class="btn-ghost btn" placeholder="Search Pok√©mon...">
        </div>
        <div class="hstack">
          <select id="pkSort" class="btn btn-ghost">
            <option value="new">Newest</option>
            <option value="priceAsc">Price ‚Üë</option>
            <option value="priceDesc">Price ‚Üì</option>
            <option value="alpha">A‚ÄìZ</option>
          </select>
        </div>
      </div>
      <div id="pkList" class="grid gap-3"></div>
    </section>

    <!-- Divider -->
    <div class="h-8"></div>

    <!-- Items grid -->
    <section class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="brand text-lg">üß∫ Shop</div>
        <div class="hstack">
          <input id="qItems" class="btn btn-ghost" placeholder="Search items, categories...">
          <select id="catItems" class="btn btn-ghost"></select>
          <button id="btnReset" class="btn btn-ghost">Reset</button>
        </div>
      </div>
      <div id="itemsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>
  </div>

  <!-- Requests modal (unchanged; still posts to /shops/{shop}/requests) -->
  <dialog id="reqDlg" class="rounded-xl w-[min(100%,900px)]">
    <form method="dialog" class="p-0 m-0">
      <div class="p-4 sm:p-6 space-y-3">
        <div class="flex items-center justify-between">
          <div class="brand text-lg">Requests</div>
          <button class="btn btn-ghost">Close</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <input id="rqIgn" class="btn-ghost btn" placeholder="IGN (in-game name)">
          <input id="rqDiscord" class="btn-ghost btn" placeholder="Discord handle">
          <select id="rqType" class="btn-ghost btn">
            <option value="price-check">Price check / Request new price</option>
            <option value="selling-items">Selling items</option>
            <option value="other">Other</option>
          </select>
          <input id="rqSubject" class="btn-ghost btn" placeholder="Subject / item name (optional)">
        </div>
        <div class="space-y-2">
          <div class="text-sm text-[var(--muted)]">Add items you‚Äôre selling (optional). Uses current **Buy %** from the shop list.</div>
          <div id="rqItems" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
          <div class="text-right text-sm"><span>Estimated total:</span> <b id="rqTotal">$0</b></div>
        </div>
        <textarea id="rqMessage" class="w-full border border-[var(--ring)] rounded-lg p-3" rows="4"
                  placeholder="Details / questions..."></textarea>
        <div class="flex items-center justify-end gap-2">
          <button class="btn btn-ghost">Close</button>
          <button id="rqSend" type="button" class="btn btn-primary">Send</button>
        </div>
        <div class="text-xs text-[var(--muted)]">Submitted to Firebase ‚Üí <code>/shops/{shop}/requests</code></div>
      </div>
    </form>
  </dialog>

  <!-- Simple password prompt for Download -->
  <dialog id="pwdDlg" class="rounded-xl w-[min(100%,420px)]">
    <form method="dialog" class="p-0 m-0">
      <div class="p-6 space-y-3">
        <div class="brand text-lg">Download CSV</div>
        <input id="pwdInput" class="btn btn-ghost w-full" placeholder="Enter password">
        <div class="flex items-center justify-end gap-2">
          <button class="btn btn-ghost">Cancel</button>
          <button id="pwdOk" class="btn btn-primary" type="button">Continue</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // --- Firebase config (yours) ---------------------------------------------
    const CFG = {
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };
    const SHOP_ID = "jjblossoms";
    const BUY_RATE = 0.85;
    const DL_PASSWORD = "44312"; // for the Download button

    // --- Firebase boot -------------------------------------------------------
    const app = firebase.initializeApp(CFG);
    const auth = firebase.auth();
    const db = firebase.database();
    auth.signInAnonymously().catch(console.error);

    const refItems = () => db.ref(`/shops/${SHOP_ID}/items`);
    const refPk    = () => db.ref(`/shops/${SHOP_ID}/pokemon`);
    const refReq   = () => db.ref(`/shops/${SHOP_ID}/requests`);

    // --- State ----------------------------------------------------------------
    let ITEMS = [];
    let POKEMON = [];

    // --- Helpers --------------------------------------------------------------
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls, html) => { const n=document.createElement(tag); if(cls) n.className=cls; if(html!=null) n.innerHTML=html; return n; };
    const money = n => '$' + (Number(n||0).toLocaleString());

    // --- Pok√©mon card (IMAGE ON RIGHT) ---------------------------------------
    function renderPokemonList() {
      const q = $('#qPk').value?.toLowerCase() || '';
      const owner = $('#pkOwnerFilter').value || 'All';
      let data = POKEMON.slice();

      // Filters
      if (owner !== 'All') data = data.filter(p => p.owner === owner);
      if (q) data = data.filter(p =>
        (p.nickname||'').toLowerCase().includes(q) ||
        (p.species||'').toLowerCase().includes(q) ||
        (p.nature||'').toLowerCase().includes(q) ||
        (p.notes||'').toLowerCase().includes(q)
      );

      // Sort
      const sortBy = $('#pkSort').value;
      if (sortBy === 'priceAsc') data.sort((a,b)=>Number(a.price||0)-Number(b.price||0));
      if (sortBy === 'priceDesc') data.sort((a,b)=>Number(b.price||0)-Number(a.price||0));
      if (sortBy === 'alpha') data.sort((a,b)=> (a.species||'').localeCompare(b.species||''));
      if (sortBy === 'new') data.sort((a,b)=> (b._ts||0)-(a._ts||0));

      const wrap = $('#pkList');
      wrap.innerHTML = '';

      data.forEach(p=>{
        const imgSrc = p.img || p.image || p.imageUrl || '';
        const left = `
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold">${p.nickname ? `${p.nickname} <span class="text-[var(--muted)]">(${p.species||''})</span>` : (p.species||'')}</div>
              <div class="text-xs text-[var(--muted)]">${p.owner||''}</div>
            </div>
            <div class="hstack text-xs">
              <span class="chip">$${Number(p.price||0).toFixed(0)}</span>
              <span class="chip">Lv ${p.level||'‚Äî'}</span>
              ${p.nature?`<span class="chip">${p.nature}</span>`:''}
              ${p.shiny?`<span class="chip">‚ú® Shiny</span>`:''}
            </div>
            <div class="text-xs text-[var(--muted)] space-y-1">
              <div>${[
                p.tera?`Tera: ${p.tera}`:'',
                p.ball?`Ball: ${p.ball}`:'',
                p.held?`Held: ${p.held}`:'',
                p.ability?`Ability: ${p.ability}`:'',
                p.size?`Size: ${p.size}`:''
              ].filter(Boolean).join(' ¬∑ ')}</div>
              ${p.ivs?`<div>IVs ${p.ivs.hp||0}/${p.ivs.atk||0}/${p.ivs.def||0}/${p.ivs.spa||0}/${p.ivs.spd||0}/${p.ivs.spe||0}</div>`:''}
              ${p.evs?`<div>EVs ${p.evs.hp||0}/${p.evs.atk||0}/${p.evs.def||0}/${p.evs.spa||0}/${p.evs.spd||0}/${p.evs.spe||0}</div>`:''}
              ${p.moves?`<div>Moves: ${p.moves}</div>`:''}
              ${p.notes?`<div>${p.notes}</div>`:''}
            </div>
            <button class="btn btn-ghost text-xs">Inquire for price</button>
          </div>`;

        const right = `<div class="img-wrap">${imgSrc ? `<img alt="${p.species||'Pokemon'}" src="${imgSrc}">` : ''}</div>`;

        const card = el('div','card p-3');
        const grid = el('div','poke-grid');
        grid.innerHTML = `<div>${left}</div><div>${right}</div>`;
        card.appendChild(grid);
        $('#pkList').appendChild(card);
      });
    }

    // --- Items rendering (kept as-is) ----------------------------------------
    function fillItemCats(){
      const sel = $('#catItems'), cur = sel.value;
      const set = new Set(ITEMS.map(i=>i.category).filter(Boolean));
      sel.innerHTML = '<option value="All">All</option>';
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=>{
        const o = document.createElement('option'); o.value=o.textContent=c; sel.appendChild(o);
      });
      if (![...sel.options].find(o=>o.value===cur)) sel.value='All'; else sel.value=cur;
    }

    function renderItems(){
      const grid = $('#itemsGrid'); grid.innerHTML='';
      const q = ($('#qItems').value||'').toLowerCase();
      const cat = $('#catItems').value || 'All';
      const data = ITEMS.filter(i =>
        (cat==='All' || i.category===cat) &&
        ((i.name||'').toLowerCase().includes(q) ||
         (i.category||'').toLowerCase().includes(q) ||
         (i.notes||'').toLowerCase().includes(q))
      );

      data.forEach(it=>{
        const buy = Math.round(Number(it.sellPrice ?? it.price ?? 0) * BUY_RATE);
        const card = el('div','card p-3 space-y-2');
        card.innerHTML = `
          <div class="font-semibold">${it.name||''}</div>
          <div class="hstack text-xs">
            <span class="chip">Our Price ${money(it.sellPrice ?? it.price ?? 0)}</span>
            <span class="chip">We Buy (85%) ${money(buy)}</span>
          </div>`;
        grid.appendChild(card);
      });
    }

    // --- Requests (send) ------------------------------------------------------
    function openRequest(){
      $('#rqIgn').value=''; $('#rqDiscord').value=''; $('#rqType').value='price-check';
      $('#rqSubject').value=''; $('#rqMessage').value='';
      $('#rqTotal').textContent = '$0';
      $('#rqItems').innerHTML = ''; // simple list UI can be enhanced later
      document.getElementById('reqDlg').showModal();
    }

    async function sendRequest(){
      const ign = $('#rqIgn').value.trim();
      const discord = $('#rqDiscord').value.trim();
      const type = $('#rqType').value;
      const subject = $('#rqSubject').value.trim();
      const message = $('#rqMessage').value.trim();
      // minimal payload (your Admin reads these)
      const payload = {
        when: Date.now(),
        ign, discord, type, subject,
        message,
        selling: [],            // keep structure; Admin already supports it
        total: 0,
        status: 'open'
      };
      try{
        await refReq().push(payload);
        document.getElementById('reqDlg').close();
        alert('Request sent! We will reach out on Discord.');
      }catch(e){ console.error(e); alert('Failed to send request'); }
    }

    // --- Download CSV (password) ---------------------------------------------
    function openDownload(){
      document.getElementById('pwdDlg').showModal();
    }
    function doDownload(){
      const pwd = $('#pwdInput').value.trim();
      if(pwd !== DL_PASSWORD) return alert('Wrong password.');
      // Build a CSV snapshot from current ITEMS
      const rows = [['name','category','sell','buy(85%)']];
      ITEMS.forEach(it=>{
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        const buy = Math.round(sell * BUY_RATE);
        rows.push([it.name||'', it.category||'', sell, buy]);
      });
      const csv = rows.map(r=> r.map(val=>{
        const s=String(val??''); return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'shop.csv';
      a.click();
      document.getElementById('pwdDlg').close();
    }

    // --- Live bindings --------------------------------------------------------
    $('#btnPokemon').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
    $('#btnReload').addEventListener('click', ()=> { /* listeners already live; just nudge */ renderItems(); renderPokemonList(); });
    $('#btnRequest').addEventListener('click', openRequest);
    $('#rqSend').addEventListener('click', sendRequest);
    $('#btnDownload').addEventListener('click', openDownload);
    $('#pwdOk').addEventListener('click', doDownload);

    $('#qPk').addEventListener('input', renderPokemonList);
    $('#pkOwnerFilter').addEventListener('change', renderPokemonList);
    $('#pkSort').addEventListener('change', renderPokemonList);

    $('#qItems').addEventListener('input', renderItems);
    $('#catItems').addEventListener('change', renderItems);
    $('#btnReset').addEventListener('click', ()=>{ $('#qItems').value=''; $('#catItems').value='All'; renderItems(); });

    // --- Subscribe to Firebase -----------------------------------------------
    refItems().on('value', snap=>{
      const val = snap.val()||{};
      ITEMS = Object.values(val).sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
      fillItemCats(); renderItems();
    });
    refPk().on('value', snap=>{
      const val = snap.val()||{};
      POKEMON = Object.values(val);
      renderPokemonList();
    });
  </script>
</body>
</html>
