<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ğŸŒ¸ JJBlossoms â€” Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- XLSX for CSV import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">ğŸŒ¸ JJBlossoms â€” Admin</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add PokÃ©mon. Anonymous sign-in to Firebase Realtime Database.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn">ğŸ  Back to site</a>
        <button id="saveCfg" class="btn">ğŸ’¾ Save config</button>
        <button id="reload" class="btn">ğŸ”„ Reload</button>
        <button id="signOut" class="btn">ğŸšª Sign out</button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="lg:col-span-2 card p-4 space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)">
          <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here, e.g. {"apiKey":"...","authDomain":"...","databaseURL":"..."}'>
        </div>
        <div class="text-xs text-slate-500">
          Firebase Console â†’ Project settings â†’ General â†’ Your apps â†’ Web â†’ copy the config object.
          Enable <b>Authentication â†’ Anonymous</b> and <b>Realtime Database</b>.
        </div>
        <div class="flex items-center gap-2 text-sm">
          <div>Status:</div><div id="status" class="font-semibold text-slate-700">Not connected</div>
        </div>
      </div>

      <div class="card p-4 space-y-2">
        <div class="text-sm font-semibold">Quick actions</div>
        <button id="importCsv" class="btn">ğŸ“¥ Import items from <b>shop.csv</b></button>
        <button id="recalc" class="btn">ğŸ§® Recalculate buy prices (85%)</button>
        <button id="clearAll" class="btn">ğŸ§¹ Clear ALL items</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items panel -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items">
            <select id="catItems" class="input"></select>
          </div>
        </div>

        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category (e.g., DNA, Dungeon Frag)" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">â• Add / Update Item</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th>
                <th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- PokÃ©mon panel -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">PokÃ©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input">
              <option>All</option><option>Yerttty</option><option>Jonfiin</option>
            </select>
            <input id="qPk" class="input" placeholder="Search PokÃ©mon">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price ($)" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input" id="pkSize" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0â€“31)</div>
            <input class="input" id="ivHP"  type="number" min="0" max="31" placeholder="HP">
            <input class="input" id="ivATK" type="number" min="0" max="31" placeholder="ATK">
            <input class="input" id="ivDEF" type="number" min="0" max="31" placeholder="DEF">
            <input class="input" id="ivSPA" type="number" min="0" max="31" placeholder="SP.ATK">
            <input class="input" id="ivSPD" type="number" min="0" max="31" placeholder="SP.DEF">
            <input class="input" id="ivSPE" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0â€“252 each)</div>
            <input class="input" id="evHP"  type="number" min="0" max="252" placeholder="HP">
            <input class="input" id="evATK" type="number" min="0" max="252" placeholder="ATK">
            <input class="input" id="evDEF" type="number" min="0" max="252" placeholder="DEF">
            <input class="input" id="evSPA" type="number" min="0" max="252" placeholder="SP.ATK">
            <input class="input" id="evSPD" type="number" min="0" max="252" placeholder="SP.DEF">
            <input class="input" id="evSPE" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Extra notes (optional)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">â• Add / Update PokÃ©mon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th>
                <th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="text-xs text-slate-500">Changes sync instantly to the public site. Use search/filters to narrow, then edit inline or use +/âˆ’ buttons.</p>
  </div>

  <script>
    const BUY_RATE=0.85, LS='jjb_admin_cfg_v2';
    let app,db,auth,refItems,refPk;
    let items=[], pokemon=[];
    const $=(s)=>document.querySelector(s);
    const now=()=>Date.now();
    const tryParse=(s)=>{ try{return JSON.parse(s)}catch{return null} };
    const idify=(s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || ('id-'+Math.random().toString(36).slice(2,9));
    const saveCfg=()=> localStorage.setItem(LS, JSON.stringify({ shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value) }));
    const loadCfg=()=>{ try{const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d;}catch{return{}} };

    async function connect(){
      const shop=$('#shopId').value.trim();
      const cfg=tryParse($('#cfgJson').value);
      if(!shop || !cfg){ $('#status').textContent='Missing config or Shop ID'; return; }
      try{
        app=firebase.apps.length? firebase.app() : firebase.initializeApp(cfg);
        auth=firebase.auth();
        await auth.signInAnonymously();
        db=firebase.database();
        refItems=db.ref(`/shops/${shop}/items`);
        refPk   =db.ref(`/shops/${shop}/pokemon`);
        $('#status').textContent='Connected âœ“';

        refItems.on('value',snap=>{
          const v=snap.val()||{};
          items=Object.values(v).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
          renderItems(); fillItemCats();
        });
        refPk.on('value',snap=>{
          const v=snap.val()||{};
          pokemon=Object.values(v).sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||'')); 
          renderPk();
        });
      }catch(e){ console.error(e); $('#status').textContent='Error connecting'; }
    }

    // Helpers to write
    function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
    function removeItem(id){ refItems.child(id).remove().catch(console.error); }
    function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
    function removePk(id){ refPk.child(id).remove().catch(console.error); }

    // Items UI
    function fillItemCats(){
      const sel=$('#catItems'); const cur=sel.value;
      const set=new Set(items.map(i=>i.category).filter(Boolean));
      sel.innerHTML=''; sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      sel.value = [...sel.options].so
