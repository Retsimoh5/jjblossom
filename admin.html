<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>🌸 JJBlossoms — Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border-radius:.75rem;border:1px solid #cbd5e1;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .input{width:100%;padding:.55rem .75rem;border:1px solid #cbd5e1;border-radius:.75rem}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
    table input{min-width:5rem}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">🌸 JJBlossoms — Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pokémon. Requests from the site are listed at the bottom.</p>
      </div>
      <a class="btn" href="./index.html">🏠 Back to site</a>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON object'>
      </div>
      <div class="text-xs text-slate-500">Enable <b>Authentication → Anonymous</b> and <b>Realtime Database</b> in Firebase. Then paste your Web app config JSON here and click <b>Save config</b>.</div>
      <div class="flex items-center gap-2">
        <button id="saveCfg" class="btn">💾 Save config</button>
        <button id="reload" class="btn">🔄 Reload</button>
        <button id="signOut" class="btn">🚪 Sign out</button>
        <div class="ml-auto text-sm">Status: <b id="status">Not connected</b></div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items">
            <select id="catItems" class="input"></select>
          </div>
        </div>

        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input id="itemName" class="input" placeholder="Item name" required>
          <input id="itemCat"  class="input" placeholder="Category" required>
          <input id="itemPrice" class="input" type="number" placeholder="Sell price ($)" required>
          <input id="itemStock" class="input" type="number" placeholder="Stock (optional)">
          <input id="itemNotes" class="input col-span-2" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Item</button>
        </form>

        <div class="flex items-center gap-2">
          <button id="importCsv" class="btn">📥 Import items from <b>shop.csv</b></button>
          <div class="flex items-center gap-2">
            <label class="text-sm">Recalc buy (%)</label>
            <input id="buyPct" class="input w-20" type="number" min="1" max="100" value="85">
            <button id="recalc" class="btn">🧮 Apply</button>
          </div>
          <button id="clearAll" class="btn">🧹 Clear ALL</button>
          <button id="exportCsv" class="btn">⬇️ Export CSV</button>
        </div>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Name</th><th class="p-3">Category</th>
              <th class="p-3">Sell</th><th class="p-3">Buy(%)</th>
              <th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- Pokémon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pokémon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search Pokémon">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select id="pkOwner" class="input" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input id="pkNickname" class="input" placeholder="Nickname (optional)">
          <input id="pkSpecies" class="input" placeholder="Species" required>
          <input id="pkLevel" class="input" type="number" min="1" placeholder="Level" required>
          <input id="pkNature" class="input" placeholder="Nature">
          <input id="pkPrice" class="input" type="number" min="0" placeholder="Price" required>
          <input id="pkTera" class="input" placeholder="Tera Type (optional)">
          <input id="pkBall" class="input" placeholder="Caught Ball (optional)">
          <input id="pkHeld" class="input" placeholder="Held Item (optional)">
          <input id="pkAbility" class="input" placeholder="Ability (optional)">
          <input id="pkSize" class="input" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0–31)</div>
            <input id="ivHP"  class="input" type="number" min="0" max="31" placeholder="HP">
            <input id="ivATK" class="input" type="number" min="0" max="31" placeholder="ATK">
            <input id="ivDEF" class="input" type="number" min="0" max="31" placeholder="DEF">
            <input id="ivSPA" class="input" type="number" min="0" max="31" placeholder="SP.ATK">
            <input id="ivSPD" class="input" type="number" min="0" max="31" placeholder="SP.DEF">
            <input id="ivSPE" class="input" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0–252 each)</div>
            <input id="evHP"  class="input" type="number" min="0" max="252" placeholder="HP">
            <input id="evATK" class="input" type="number" min="0" max="252" placeholder="ATK">
            <input id="evDEF" class="input" type="number" min="0" max="252" placeholder="DEF">
            <input id="evSPA" class="input" type="number" min="0" max="252" placeholder="SP.ATK">
            <input id="evSPD" class="input" type="number" min="0" max="252" placeholder="SP.DEF">
            <input id="evSPE" class="input" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input id="pkMoves" class="input col-span-2" placeholder="Moves (comma-separated)">
          <textarea id="pkNotes" class="input col-span-2" placeholder="Extra notes (optional)"></textarea>
          <input id="pkImg" class="input col-span-2" placeholder="Image URL (optional)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Pokémon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th>
              <th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Requests -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Requests (from site)</h2>
        <div class="flex items-center gap-2">
          <input id="qReq" class="input" placeholder="Search IGN/Discord/subject…">
          <select id="reqState" class="input"><option value="All">All</option><option value="open">Open</option><option value="closed">Closed</option></select>
        </div>
      </div>

      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
            <th class="p-3">When</th><th class="p-3">IGN</th><th class="p-3">Discord</th>
            <th class="p-3">Type</th><th class="p-3">Subject / Summary</th>
            <th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Actions</th>
          </tr></thead>
          <tbody id="rowsReq"></tbody>
        </table>
      </div>
      <div class="text-xs text-slate-500">Edits save instantly. Export CSV any time for a backup (<a id="reqExport" href="#" class="underline">shop.csv</a>).</div>
    </section>
  </div>

  <!-- Request details modal -->
  <dialog id="dlgReq" class="w-[min(880px,95vw)] rounded-2xl border p-0">
    <div class="p-4 border-b flex items-center justify-between">
      <div class="brand font-bold text-lg">Request details</div>
      <button class="btn" onclick="document.getElementById('dlgReq').close()">Close</button>
    </div>
    <div class="p-4 space-y-3" id="reqBody"></div>
    <div class="p-4 border-t flex items-center justify-end gap-2">
      <label class="text-sm flex items-center gap-2"><input id="reqClosed" type="checkbox"> Mark closed</label>
      <button id="reqDelete" class="btn">🗑️ Delete</button>
      <button id="reqDone" class="btn btn-primary">Done</button>
    </div>
  </dialog>

  <script>
    /* Firebase */
    const FB = {
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };
    const app  = firebase.initializeApp(FB);
    const auth = firebase.auth();
    const db   = firebase.database();

    /* Helpers */
    const $  = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const money = n => '$'+Math.round(Number(n||0)).toLocaleString();
    const idify = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9));

    /* Config persistence */
    const LS='jjb_admin_cfg_v2';
    function saveCfg(){
      localStorage.setItem(LS, JSON.stringify({shopId:$('#shopId').value.trim(), cfg: JSON.parse($('#cfgJson').value||'{}')}));
    }
    function loadCfg(){
      try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d; }catch{return{}}
    }

    /* Live references */
    let refItems, refPk, refReq;
    let ITEMS=[], POKES=[], REQS=[];
    const BUY_RATE_DEFAULT = 0.85;

    /* Connect */
    async function connect(){
      $('#status').textContent='Connecting…';
      await auth.signInAnonymously();
      const shop=$('#shopId').value.trim()||'jjblossoms';
      refItems = db.ref(`/shops/${shop}/items`);
      refPk    = db.ref(`/shops/${shop}/pokemon`);
      refReq   = db.ref(`/shops/${shop}/requests`);

      refItems.on('value', s=>{ const v=s.val()||{}; ITEMS=Object.values(v); renderItems(); });
      refPk.on('value', s=>{ const v=s.val()||{}; POKES=Object.values(v); renderPk(); });
      refReq.on('value', s=>{ const v=s.val()||{}; REQS=Object.entries(v).map(([id,r])=>({...r,_id:id})).sort((a,b)=>b.ts-a.ts); renderReqs(); });

      $('#status').textContent='Connected ✓';
    }

    /* Items UI */
    function fillItemCats(){ const sel=$('#catItems'); const set=new Set(ITEMS.map(i=>i.category).filter(Boolean)); const cur=sel.value; sel.innerHTML='<option>All</option>'+[...set].sort((a,b)=>a.localeCompare(b)).map(c=>`<option>${c}</option>`).join(''); if([...sel.options].some(o=>o.value===cur)) sel.value=cur; }
    function renderItems(){
      fillItemCats();
      const q=($('#qItems').value||'').toLowerCase(), cat=$('#catItems').value||'All';
      const tb=$('#rowsItems'); tb.innerHTML='';
      ITEMS.filter(it=>(cat==='All'||it.category===cat) && ((it.name||'').toLowerCase().includes(q)||(it.category||'').toLowerCase().includes(q)||(it.notes||'').toLowerCase().includes(q)))
        .sort((a,b)=>a.name.localeCompare(b.name))
        .forEach(it=>{
          const tr=document.createElement('tr');
          const sell = Number(it.sellPrice??it.price??0);
          const buy  = Number(it.buyPrice ?? Math.round(sell*(Number($('#buyPct').value||85)/100)));
          tr.innerHTML = `
            <td class="p-2">${it.name||''}</td>
            <td class="p-2">${it.category||''}</td>
            <td class="p-2"><input class="input w-24" data-id="${it.id}" data-field="sellPrice" value="${sell}"></td>
            <td class="p-2"><span class="px-2 py-1 rounded bg-slate-100 border">${money(buy)}</span></td>
            <td class="p-2 flex items-center gap-2"><button class="btn" data-act="dec" data-id="${it.id}">−</button><input class="input w-16" data-id="${it.id}" data-field="stock" value="${it.stock===''?'':it.stock}"><button class="btn" data-act="inc" data-id="${it.id}">+</button></td>
            <td class="p-2"><input class="input" data-id="${it.id}" data-field="notes" value="${it.notes||''}"></td>
            <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
          tb.appendChild(tr);
        });
    }

    /* Pokémon UI */
    function renderPk(){
      const q=($('#qPk').value||'').toLowerCase(), owner=$('#pkOwnerFilter').value;
      const tb=$('#rowsPk'); tb.innerHTML='';
      POKES.filter(p=>(owner==='All'||p.owner===owner)&&((p.species||'').toLowerCase().includes(q)||(p.nickname||'').toLowerCase().includes(q)||(p.nature||'').toLowerCase().includes(q)))
        .sort((a,b)=>(a.owner||'').localeCompare(b.owner||'')||(a.species||'').localeCompare(b.species||''))
        .forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td class="p-2">${p.owner||''}</td>
            <td class="p-2">${p.nickname?`${p.nickname} (${p.species})`:p.species}</td>
            <td class="p-2">${p.level||''}</td>
            <td class="p-2">${p.nature||''}</td>
            <td class="p-2">${money(p.price||0)}</td>
            <td class="p-2"><input class="input" data-pk-id="${p.id}" data-field="notes" value="${p.notes||''}"></td>
            <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`;
          tb.appendChild(tr);
        });
    }

    /* Requests UI */
    function renderReqs(){
      const q=($('#qReq').value||'').toLowerCase();
      const filt=$('#reqState').value;
      const tb=$('#rowsReq'); tb.innerHTML='';
      REQS.filter(r => (filt==='All'||r.status===filt) && (
        (r.ign||'').toLowerCase().includes(q) ||
        (r.discord||'').toLowerCase().includes(q) ||
        (r.subject||'').toLowerCase().includes(q)
      )).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${new Date(r.ts||Date.now()).toLocaleString()}</td>
          <td class="p-2">${r.ign||''}</td>
          <td class="p-2">${r.discord||''}</td>
          <td class="p-2"><span class="px-2 py-1 rounded bg-slate-100 border">${r.type||''}</span></td>
          <td class="p-2">${r.subject||'(no summary)'}</td>
          <td class="p-2">${money(r.total||0)}</td>
          <td class="p-2">${r.status||'open'}</td>
          <td class="p-2"><button class="btn" data-act="openReq" data-id="${r._id}">Open</button></td>`;
        tb.appendChild(tr);
      });
    }

    /* Add / Update item */
    $('#addItemForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name=$('#itemName').value.trim();
      const category=$('#itemCat').value.trim();
      const sell=Number($('#itemPrice').value||0);
      const stock=$('#itemStock').value===''?'':Number($('#itemStock').value);
      const notes=$('#itemNotes').value.trim();
      const id=idify(name+'-'+category);
      const buyPct = Number($('#buyPct').value||85)/100;
      db.ref(`/shops/${$('#shopId').value.trim()}/items/${id}`).set({
        id,name,category,sellPrice:sell,buyPrice:Math.round(sell*buyPct),stock,notes,_ts:Date.now()
      });
      e.target.reset();
    });

    /* Pokémon add/update */
    $('#addPkForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const shop=$('#shopId').value.trim();
      const owner=$('#pkOwner').value;
      const id=idify(owner+'-'+($('#pkSpecies').value||'')+'-'+Date.now());
      const payload={
        id, owner,
        nickname: $('#pkNickname').value.trim(),
        species: $('#pkSpecies').value.trim(),
        level: Number($('#pkLevel').value||1),
        nature: $('#pkNature').value.trim(),
        price: Number($('#pkPrice').value||0),
        tera: $('#pkTera').value.trim(),
        ball: $('#pkBall').value.trim(),
        held: $('#pkHeld').value.trim(),
        ability: $('#pkAbility').value.trim(),
        size: $('#pkSize').value.trim(),
        shiny: $('#pkShiny').checked,
        neutered: $('#pkNeutered').checked,
        ivs:{ hp:Number($('#ivHP').value||0), atk:Number($('#ivATK').value||0), def:Number($('#ivDEF').value||0), spa:Number($('#ivSPA').value||0), spd:Number($('#ivSPD').value||0), spe:Number($('#ivSPE').value||0) },
        evs:{ hp:Number($('#evHP').value||0), atk:Number($('#evATK').value||0), def:Number($('#evDEF').value||0), spa:Number($('#evSPA').value||0), spd:Number($('#evSPD').value||0), spe:Number($('#evSPE').value||0) },
        moves: $('#pkMoves').value.trim(),
        notes: $('#pkNotes').value.trim(),
        img:   $('#pkImg').value.trim(),
        _ts: Date.now()
      };
      db.ref(`/shops/${shop}/pokemon/${id}`).set(payload);
      e.target.reset();
    });

    /* Inline edits / actions */
    document.addEventListener('input', (e)=>{
      const t=e.target;
      if(t.matches('input[data-id]')){
        const id=t.getAttribute('data-id'); const field=t.getAttribute('data-field');
        let v=t.value; if(field==='stock'||field==='sellPrice') v = v===''?'':Number(v);
        db.ref(`/shops/${$('#shopId').value.trim()}/items/${id}/${field}`).set(v);
      }
      if(t.matches('input[data-pk-id]')){
        const id=t.getAttribute('data-pk-id'); const field=t.getAttribute('data-field');
        db.ref(`/shops/${$('#shopId').value.trim()}/pokemon/${id}/${field}`).set(t.value);
      }
    });
    document.addEventListener('click', (e)=>{
      const t=e.target, id=t.getAttribute('data-id');
      if(t.dataset.act==='inc'||t.dataset.act==='dec'){
        const shop=$('#shopId').value.trim(); const ref=db.ref(`/shops/${shop}/items/${id}`);
        ref.get().then(s=>{ const it=s.val()||{}; const cur=Number(it.stock||0); const next = t.dataset.act==='inc' ? cur+1 : Math.max(0,cur-1); ref.child('stock').set(next); });
      }
      if(t.dataset.act==='delItem'){
        if(confirm('Delete item?')) db.ref(`/shops/${$('#shopId').value.trim()}/items/${id}`).remove();
      }
      if(t.dataset.act==='delPk'){
        if(confirm('Delete Pokémon?')) db.ref(`/shops/${$('#shopId').value.trim()}/pokemon/${id}`).remove();
      }
      if(t.dataset.act==='openReq'){
        openReq(t.getAttribute('data-id'));
      }
    });

    /* Recalc buy, import/export, search */
    $('#recalc').addEventListener('click', async (e)=>{
      e.preventDefault();
      const shop=$('#shopId').value.trim();
      const pct = Number($('#buyPct').value||85)/100;
      const updates = {};
      ITEMS.forEach(it=>{
        const sell=Number(it.sellPrice??it.price||0);
        updates[it.id+'/buyPrice'] = Math.round(sell*pct);
      });
      await db.ref(`/shops/${shop}/items`).update(updates);
      alert('Buy prices recalculated.');
    });
    $('#importCsv').addEventListener('click', async ()=>{
      const res=await fetch('shop.csv',{cache:'no-store'});
      if(!res.ok) return alert('shop.csv not found in repo root.');
      const txt=await res.text();
      const wb=XLSX.read(txt,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
      const hdr=(rows[0]||[]).map(x=>String(x||'').toLowerCase());
      const I=(h)=>hdr.findIndex(z=>z.includes(h));
      const shop=$('#shopId').value.trim();
      for(const r of rows.slice(1)){
        const name=String(r[I('name')]||'').trim(); if(!name) continue;
        const category=String(r[I('cat')]||'').trim();
        const id=idify(name+'-'+category);
        const sell=Number(r[I('sell')]||r[I('price')]||0);
        const stock=r[I('stock')]===''||r[I('stock')]==null? '': Number(r[I('stock')]);
        const notes=String(r[I('note')]||r[I('desc')]||r[I('notes')]||'').trim();
        await db.ref(`/shops/${shop}/items/${id}`).set({
          id,name,category,sellPrice:sell,buyPrice:Math.round(sell*(Number($('#buyPct').value||85)/100)),stock,notes,_ts:Date.now()
        });
      }
      alert('Imported!');
    });
    $('#exportCsv').addEventListener('click', async ()=>{
      const rows=[['name','category','sell_price','buy_price','stock','notes']];
      ITEMS.forEach(it=> rows.push([it.name||'',it.category||'',it.sellPrice||0,(it.buyPrice??Math.round((it.sellPrice||0)* (Number($('#buyPct').value||85)/100))), it.stock===''?'':it.stock, it.notes||'']));
      const csv=rows.map(r=>r.map(v=>{v=(v===null||v===undefined)?'':String(v); return /[,"\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;}).join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='shop.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#qItems').addEventListener('input', renderItems);
    $('#catItems').addEventListener('change', renderItems);
    $('#qPk').addEventListener('input', renderPk);
    $('#pkOwnerFilter').addEventListener('change', renderPk);
    $('#qReq').addEventListener('input', renderReqs);
    $('#reqState').addEventListener('change', renderReqs);

    /* Request details modal */
    let OPEN_REQ_ID=null;
    function openReq(id){
      const r = REQS.find(x=>x._id===id); if(!r) return;
      OPEN_REQ_ID=id;
      const body = $('#reqBody');
      const when = new Date(r.ts||Date.now()).toLocaleString();
      const msg  = r.message && r.message.trim() ? r.message.trim() : '(no extra details provided)';
      const lines = (r.items||[]).map(l=>`<tr><td class="p-2">${l.name}</td><td class="p-2 text-right">${l.qty}</td><td class="p-2 text-right">${money(l.unit)}</td><td class="p-2 text-right">${money(l.line)}</td></tr>`).join('') || `<tr><td class="p-2 text-slate-500" colspan="4">No selling items were listed</td></tr>`;
      body.innerHTML = `
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div><b>When:</b> ${when}</div>
            <div><b>IGN:</b> ${r.ign||''}</div>
            <div><b>Type:</b> ${r.type||''}</div>
          </div>
          <div>
            <div><b>Status:</b> ${r.status||'open'}</div>
            <div><b>Discord:</b> ${r.discord||''}</div>
            <div><b>Subject:</b> ${r.subject||''}</div>
          </div>
        </div>
        <div class="text-sm"><b>Message:</b><div class="mt-1 p-2 border rounded bg-slate-50">${msg.replace(/\n/g,'<br>')}</div></div>
        <div class="text-sm">
          <div class="font-semibold mb-1">Selling items</div>
          <div class="overflow-auto rounded border">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
                <th class="p-2">Item</th><th class="p-2 text-right">Qty</th><th class="p-2 text-right">Price</th><th class="p-2 text-right">Line</th>
              </tr></thead>
              <tbody>${lines}</tbody>
              <tfoot><tr><td class="p-2" colspan="3"><b>Total</b></td><td class="p-2 text-right"><b>${money(r.total||0)}</b></td></tr></tfoot>
            </table>
          </div>
        </div>
      `;
      $('#reqClosed').checked = r.status==='closed';
      $('#dlgReq').showModal();
    }
    $('#reqDone').addEventListener('click', async ()=>{
      if(!OPEN_REQ_ID) return;
      const closed = $('#reqClosed').checked;
      await refReq.child(OPEN_REQ_ID).update({ status: closed?'closed':'open', _closedTs: closed?Date.now():null });
      $('#dlgReq').close();
    });
    $('#reqDelete').addEventListener('click', async ()=>{
      if(!OPEN_REQ_ID) return;
      if(!confirm('Delete this request?')) return;
      await refReq.child(OPEN_REQ_ID).remove();
      $('#dlgReq').close();
    });

    /* Clear all items */
    $('#clearAll').addEventListener('click', async ()=>{
      if(!confirm('Delete ALL items under this shop?')) return;
      await refItems.remove();
    });

    /* Config buttons */
    $('#saveCfg').addEventListener('click', ()=>{ saveCfg(); connect(); });
    $('#reload').addEventListener('click', ()=> connect());
    $('#signOut').addEventListener('click', ()=> auth.signOut().then(()=>{$('#status').textContent='Signed out'}));

    /* Boot */
    loadCfg();
    connect();
  </script>
</body>
</html>
