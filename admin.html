<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-dark{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
    dialog::backdrop{ background:rgba(15,23,42,.45) }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">

    <!-- Header / Config -->
    <header class="flex items-end justify-between gap-3 flex-wrap">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pok√©mon. DNA/Dungeon Frags are handled correctly.</p>
      </div>
      <a href="./index.html" class="btn">üè† Back to site</a>
    </header>

    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
      </div>
      <div class="text-xs text-slate-500">
        Tip: Enable <b>Authentication ‚Üí Anonymous</b> and create <b>Realtime Database</b>.
        Rule <code>{"rules":{"*.read":true,"shops":{"$shop":{"*.write":"auth != null"}}}}</code>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span>Status:</span> <span id="status" class="font-semibold text-slate-700">Not connected</span>
        <div class="ml-auto flex items-center gap-2">
          <button id="saveCfg" class="btn">üíæ Save config</button>
          <button id="reload" class="btn">üîÑ Reload</button>
          <button id="signOut" class="btn">üö™ Sign out</button>
        </div>
      </div>
    </section>

    <!-- Quick actions -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center gap-2 flex-wrap">
        <button id="importCsv" class="btn">üì• Import items from <b>shop.csv</b></button>
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600">Recalc buy %</label>
          <input id="buyPct" type="number" class="input w-24" value="85" min="0" max="100">
          <button id="recalcPct" class="btn">üßÆ Recalculate</button>
        </div>
        <button id="clearAll" class="btn">üßπ Clear ALL</button>
      </div>
    </section>

    <!-- Items + Pok√©mon -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items, categories...">
            <select id="catItems" class="input"></select>
          </div>
        </div>

        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category (e.g., DNA, Dungeon Frag)" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-dark col-span-2" type="submit">‚ûï Add / Update Item</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Name</th><th class="p-3">Category</th>
                <th class="p-3">Sell</th><th class="p-3">Buy(%)</th>
                <th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
        <p class="text-xs text-slate-500">Changes sync instantly. Use inline edits or +/- to adjust stock.</p>
      </section>

      <!-- Pok√©mon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pok√©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search Pok√©mon...">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level">
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price ($)" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input" id="pkSize" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0‚Äì31)</div>
            <input class="input" id="ivHP"  type="number" min="0" max="31" placeholder="HP">
            <input class="input" id="ivATK" type="number" min="0" max="31" placeholder="ATK">
            <input class="input" id="ivDEF" type="number" min="0" max="31" placeholder="DEF">
            <input class="input" id="ivSPA" type="number" min="0" max="31" placeholder="SP.ATK">
            <input class="input" id="ivSPD" type="number" min="0" max="31" placeholder="SP.DEF">
            <input class="input" id="ivSPE" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0‚Äì252 each, optional)</div>
            <input class="input" id="evHP"  type="number" min="0" max="252" placeholder="HP">
            <input class="input" id="evATK" type="number" min="0" max="252" placeholder="ATK">
            <input class="input" id="evDEF" type="number" min="0" max="252" placeholder="DEF">
            <input class="input" id="evSPA" type="number" min="0" max="252" placeholder="SP.ATK">
            <input class="input" id="evSPD" type="number" min="0" max="252" placeholder="SP.DEF">
            <input class="input" id="evSPE" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Notes / extra (optional)"></textarea>
          <button class="btn btn-dark col-span-2" type="submit">‚ûï Add / Update Pok√©mon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th>
                <th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Requests -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Requests (from site)</h2>
        <div class="flex items-center gap-2">
          <input id="reqSearch" class="input" placeholder="Search IGN/Discord/subject...">
          <select id="reqFilter" class="input">
            <option value="all">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0">
            <tr class="text-left">
              <th class="p-3">When</th><th class="p-3">IGN</th><th class="p-3">Discord</th>
              <th class="p-3">Type</th><th class="p-3">Subject / Summary</th>
              <th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="rowsReqs"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500">Edits save instantly. Export CSV any time for a backup (<a href="shop.csv" target="_blank">shop.csv</a>).</p>
    </section>

  </div>

  <!-- Request modal -->
  <dialog id="reqModal" class="rounded-xl p-0 w-[min(880px,96vw)]">
    <div class="p-4 sm:p-6 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="brand text-lg">Request details</h3>
        <button class="btn" data-close>Close</button>
      </div>
      <div id="reqMeta" class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm"></div>

      <div>
        <div class="text-xs font-semibold mb-1">Message</div>
        <div id="reqMsg" class="p-3 rounded-lg border bg-slate-50 text-sm text-slate-700">(no extra details provided)</div>
      </div>

      <div class="overflow-auto rounded-xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0">
            <tr class="text-left"><th class="p-3">Item</th><th class="p-3">Qty</th><th class="p-3">Price</th><th class="p-3">Line</th></tr>
          </thead>
          <tbody id="reqLines"></tbody>
          <tfoot>
            <tr><td class="p-3 font-semibold" colspan="3">Total</td><td id="reqTotal" class="p-3 font-semibold"></td></tr>
          </tfoot>
        </table>
      </div>

      <div class="flex items-center gap-2 justify-between">
        <label class="flex items-center gap-2 text-sm"><input id="reqClosed" type="checkbox"> Mark closed</label>
        <div class="flex items-center gap-2">
          <button id="reqDelete" class="btn">üóë Delete</button>
          <button data-close class="btn btn-dark">Done</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    /* ---------- helpers ---------- */
    const $ = s => document.querySelector(s);
    const el = (h, cls='') => { const n=document.createElement(h); if(cls) n.className=cls; return n; };
    const idify = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9));
    const tryJSON = s => { try{return JSON.parse(s)}catch{return null} };
    const now = () => Date.now();
    const fmt = n => '$'+(Math.round(Number(n)||0)).toLocaleString();

    const LS = 'jjb_admin_cfg_v3';
    const saveCfg = () => localStorage.setItem(LS, JSON.stringify({shopId: $('#shopId').value.trim(), cfg: tryJSON($('#cfgJson').value)}));
    const loadCfg = () => { try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d; }catch{return{}} };

    /* ---------- firebase ---------- */
    let app, auth, db, refItems, refPk, refReq;
    let items = [], itemsMap = new Map();
    let pokemon = [];
    let requests = [];
    function connect(){
      const shop = $('#shopId').value.trim();
      const cfg = tryJSON($('#cfgJson').value);
      if(!shop || !cfg){ $('#status').textContent='Missing config or Shop ID'; return; }
      try{
        app = firebase.apps.length? firebase.app(): firebase.initializeApp(cfg);
        auth = firebase.auth();
        auth.signInAnonymously().then(()=>{
          db = firebase.database();
          refItems = db.ref(`/shops/${shop}/items`);
          refPk    = db.ref(`/shops/${shop}/pokemon`);
          refReq   = db.ref(`/shops/${shop}/requests`);
          $('#status').textContent = 'Connected ‚úì';

          refItems.on('value', snap=>{
            const v = snap.val()||{};
            items = Object.values(v);
            items.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
            itemsMap = new Map(items.map(it=>[String(it.name||'').toLowerCase(), it]));
            renderItems(); fillItemCats();
          });

          refPk.on('value', snap=>{
            const v = snap.val()||{};
            pokemon = Object.values(v);
            pokemon.sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||'')); 
            renderPk();
          });

          refReq.on('value', snap=>{
            const v = snap.val()||{};
            requests = Object.entries(v).map(([id,r])=>({...r,id}));
            requests.sort((a,b)=> (b.ts||0)-(a.ts||0));
            renderReqs();
          });
        });
      }catch(e){ console.error(e); $('#status').textContent='Error connecting'; }
    }

    /* ---------- items ---------- */
    const BUY = ()=> Math.max(0, Math.min(100, Number($('#buyPct').value||85)))/100;

    function fillItemCats(){
      const sel = $('#catItems'); const cur = sel.value;
      const set = new Set(items.map(i=>i.category).filter(Boolean));
      sel.innerHTML = ''; sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      sel.value = [...sel.options].some(o=>o.value===cur)? cur : 'All';
    }

    function renderItems(){
      const q = $('#qItems').value.toLowerCase();
      const cat = $('#catItems').value || 'All';
      const tb = $('#rowsItems'); tb.innerHTML='';
      const data = items.filter(it => (cat==='All'||it.category===cat) && (
        (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)
      ));
      for(const it of data){
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        const buy  = Number(it.buyPrice ?? Math.round(sell * BUY()));
        const tr = el('tr');
        tr.innerHTML = `
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2"><input class="input w-24" data-id="${it.id}" data-field="sellPrice" value="${sell||''}"></td>
          <td class="p-2">${fmt(buy)}<div class="text-[10px] text-slate-400">${Math.round(BUY()*100)}%</div></td>
          <td class="p-2"><div class="flex items-center gap-2"><button class="btn" data-act="dec" data-id="${it.id}">‚àí</button><input class="input w-20" data-id="${it.id}" data-field="stock" value="${it.stock===''?'':it.stock}"><button class="btn" data-act="inc" data-id="${it.id}">+</button></div></td>
          <td class="p-2"><input class="input" data-id="${it.id}" data-field="notes" value="${it.notes||''}"></td>
          <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    function patchItem(id, changes){
      const cur = items.find(x=>x.id===id) || {id};
      // keep buyPrice in sync if sellPrice updated
      if('sellPrice' in changes){
        const sell = Number(changes.sellPrice||0);
        changes.buyPrice = Math.round(sell * BUY());
      }
      refItems.child(id).set({...cur, ...changes, _ts: now(), id}).catch(console.error);
    }
    function removeItem(id){ refItems.child(id).remove().catch(console.error); }

    /* ---------- pok√©mon ---------- */
    function renderPk(){
      const q = $('#qPk').value.toLowerCase();
      const owner = $('#pkOwnerFilter').value;
      const tb = $('#rowsPk'); tb.innerHTML='';
      const data = pokemon.filter(p=> (owner==='All'||p.owner===owner) && (
        (p.species||'').toLowerCase().includes(q) || (p.nickname||'').toLowerCase().includes(q) || (p.nature||'').toLowerCase().includes(q) || (p.notes||'').toLowerCase().includes(q)
      ));
      for(const pkm of data){
        const tr = el('tr');
        tr.innerHTML = `
          <td class="p-2">${pkm.owner||''}</td>
          <td class="p-2">${pkm.nickname?`${pkm.nickname} (${pkm.species})`:(pkm.species||'')}</td>
          <td class="p-2">${pkm.level||''}</td>
          <td class="p-2">${pkm.nature||''}</td>
          <td class="p-2"><input class="input w-24" data-pk-id="${pkm.id}" data-field="price" value="${pkm.price||''}"></td>
          <td class="p-2"><input class="input" data-pk-id="${pkm.id}" data-field="notes" value="${pkm.notes||''}"></td>
          <td class="p-2"><button class="btn" data-act="delPk" data-id="${pkm.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }
    function patchPk(id, changes){
      const cur = pokemon.find(x=>x.id===id) || {id};
      refPk.child(id).set({...cur, ...changes, _ts: now(), id}).catch(console.error);
    }
    function removePk(id){ refPk.child(id).remove().catch(console.error); }

    /* ---------- requests ---------- */
    function renderReqs(){
      const q = ($('#reqSearch').value||'').toLowerCase();
      const filt = $('#reqFilter').value;
      const tb = $('#rowsReqs'); tb.innerHTML='';
      const data = requests.filter(r=>{
        const s = (r.ign||'')+' '+(r.discord||'')+' '+(r.subject||'')+' '+(r.type||'');
        const okQ = s.toLowerCase().includes(q);
        const okF = (filt==='all') || ((r.status||'open')===filt);
        return okQ && okF;
      });
      for(const r of data){
        const tr = el('tr');
        const when = r.ts ? new Date(r.ts).toLocaleString() : '‚Äî';
        const total = fmt(r.total||computeReqTotal(r));
        tr.innerHTML = `
          <td class="p-3">${when}</td>
          <td class="p-3">${r.ign||'‚Äî'}</td>
          <td class="p-3">${r.discord||'‚Äî'}</td>
          <td class="p-3"><span class="px-2 py-1 rounded-full border">${r.type||'‚Äî'}</span></td>
          <td class="p-3">${r.subject||'(no summary)'}</td>
          <td class="p-3">${total}</td>
          <td class="p-3">${r.status||'open'}</td>
          <td class="p-3"><button class="btn" data-act="openReq" data-id="${r.id}">Open</button></td>`;
        tb.appendChild(tr);
      }
    }

    function computeReqTotal(r){
      const list = r.items || r.list || [];
      let sum = 0;
      for(const it of list){
        const qty = Number(it.qty||it.q||1);
        let price = Number(it.price||0);
        if(!price){
          // fallback to our current buy price
          const ref = itemsMap.get(String(it.name||'').toLowerCase());
          const sell = Number(ref?.sellPrice ?? ref?.price ?? 0);
          const buy  = Number(ref?.buyPrice ?? Math.round(sell * BUY()));
          price = buy;
        }
        sum += qty * price;
      }
      return sum;
    }

    function openReq(id){
      const r = requests.find(x=>x.id===id); if(!r) return;
      const when = r.ts ? new Date(r.ts).toLocaleString() : '‚Äî';
      const meta = $('#reqMeta'); meta.innerHTML='';
      const add = (k,v)=>{ const box=el('div','p-2 rounded border bg-slate-50'); box.innerHTML=`<div class="text-[10px] uppercase text-slate-500">${k}</div><div class="font-medium">${v||'‚Äî'}</div>`; meta.appendChild(box); };
      add('When', when);
      add('IGN', r.ign||'‚Äî');
      add('Discord', r.discord||'‚Äî');
      add('Status', r.status||'open');
      add('Type', r.type||'‚Äî');
      add('Subject', r.subject||'‚Äî');

      const msg = r.message || r.details || r.msg || '';
      $('#reqMsg').textContent = msg || '(no extra details provided)';

      // lines
      const body = $('#reqLines'); body.innerHTML='';
      const list = r.items || r.list || [];
      let sum = 0;
      for(const it of list){
        const name = it.name || it.item || '‚Äî';
        const qty  = Number(it.qty||it.q||1);
        let price  = Number(it.price||0);
        if(!price){
          const ref = itemsMap.get(String(name).toLowerCase());
          const sell = Number(ref?.sellPrice ?? ref?.price ?? 0);
          const buy  = Number(ref?.buyPrice ?? Math.round(sell * BUY()));
          price = buy;
        }
        const line = qty * price;
        sum += line;
        const tr = el('tr');
        tr.innerHTML = `<td class="p-3">${name}</td><td class="p-3">${qty}</td><td class="p-3">${fmt(price)}</td><td class="p-3">${fmt(line)}</td>`;
        body.appendChild(tr);
      }
      if(!list.length){
        const tr = el('tr'); tr.innerHTML = `<td class="p-3 text-slate-500" colspan="4">No selling items were listed</td>`;
        body.appendChild(tr);
      }
      $('#reqTotal').textContent = fmt(r.total || sum);

      // actions
      $('#reqClosed').checked = (r.status==='closed');
      $('#reqClosed').onchange = ()=> {
        const status = $('#reqClosed').checked ? 'closed' : 'open';
        refReq.child(r.id).update({status});
      };
      $('#reqDelete').onclick = ()=> {
        if(confirm('Delete this request?')) refReq.child(r.id).remove();
        $('#reqModal').close();
      };

      const dlg = $('#reqModal');
      dlg.showModal();
    }

    /* ---------- events ---------- */
    document.addEventListener('click', e=>{
      const t = e.target;
      if(t.matches('[data-close]')) $('#reqModal').close();

      if(t.dataset.act==='openReq'){ openReq(t.dataset.id); }
      if(t.dataset.act==='inc'){ const id=t.dataset.id; const cur=items.find(x=>x.id===id); patchItem(id,{stock:Number(cur?.stock||0)+1}); }
      if(t.dataset.act==='dec'){ const id=t.dataset.id; const cur=items.find(x=>x.id===id); patchItem(id,{stock:Math.max(0,Number(cur?.stock||0)-1)}); }
      if(t.dataset.act==='delItem'){ if(confirm('Delete item?')) removeItem(t.dataset.id); }
      if(t.dataset.act==='delPk'){ if(confirm('Delete Pok√©mon?')) removePk(t.dataset.id); }
    });

    document.addEventListener('input', e=>{
      const t = e.target;
      if(t.matches('input[data-id]')){
        const id = t.getAttribute('data-id');
        const field = t.getAttribute('data-field');
        let v = t.value;
        if(field==='sellPrice' || field==='stock') v = v===''? '' : Number(v);
        patchItem(id, {[field]: v});
      }
      if(t.matches('input[data-pk-id]')){
        const id = t.getAttribute('data-pk-id');
        const field = t.getAttribute('data-field');
        patchPk(id, {[field]: (field==='price' ? Number(t.value||0) : t.value)});
      }
      if(t.id==='qItems'||t.id==='catItems') renderItems();
      if(t.id==='qPk'||t.id==='pkOwnerFilter') renderPk();
      if(t.id==='reqSearch'||t.id==='reqFilter') renderReqs();
    });

    // forms
    $('#addItemForm').addEventListener('submit', e=>{
      e.preventDefault();
      const name=$('#itemName').value.trim();
      const category=$('#itemCat').value.trim();
      const sell=Number($('#itemPrice').value||0);
      const stock=$('#itemStock').value===''? '' : Number($('#itemStock').value);
      const notes=$('#itemNotes').value.trim();
      const id = idify(name+'|'+category);
      refItems.child(id).set({ id, name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY()), stock, notes, _ts:now() });
      e.target.reset();
    });

    $('#addPkForm').addEventListener('submit', e=>{
      e.preventDefault();
      const owner=$('#pkOwner').value;
      const nickname=$('#pkNickname').value.trim();
      const species=$('#pkSpecies').value.trim();
      const id=idify(owner+'-'+species+'-'+Date.now());
      const level=Number($('#pkLevel').value||0);
      const nature=$('#pkNature').value.trim();
      const price=Number($('#pkPrice').value||0);
      const tera=$('#pkTera').value.trim();
      const ball=$('#pkBall').value.trim();
      const held=$('#pkHeld').value.trim();
      const ability=$('#pkAbility').value.trim();
      const size=$('#pkSize').value.trim();
      const shiny=$('#pkShiny').checked;
      const neutered=$('#pkNeutered').checked;
      const ivs={hp:Number($('#ivHP').value||0), atk:Number($('#ivATK').value||0), def:Number($('#ivDEF').value||0), spa:Number($('#ivSPA').value||0), spd:Number($('#ivSPD').value||0), spe:Number($('#ivSPE').value||0)};
      const evs={hp:Number($('#evHP').value||0), atk:Number($('#evATK').value||0), def:Number($('#evDEF').value||0), spa:Number($('#evSPA').value||0), spd:Number($('#evSPD').value||0), spe:Number($('#evSPE').value||0)};
      const moves=$('#pkMoves').value.trim();
      const notes=$('#pkNotes').value.trim();
      refPk.child(id).set({ id, owner, nickname, species, level, nature, price, tera, ball, held, ability, size, shiny, neutered, ivs, evs, moves, notes, _ts:now() });
      e.target.reset();
    });

    // buttons
    $('#saveCfg').onclick = ()=>{ saveCfg(); connect(); };
    $('#reload').onclick  = ()=> connect();
    $('#signOut').onclick = ()=> auth?.signOut().then(()=>$('#status').textContent='Signed out');

    $('#importCsv').onclick = async ()=>{
      if(!db){ alert('Connect first (Save config)'); return; }
      try{
        const res=await fetch('shop.csv',{cache:'no-store'});
        if(!res.ok) return alert('shop.csv not found');
        const txt=await res.text();
        const wb=XLSX.read(txt,{type:'string'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        if(!rows.length) return alert('CSV empty');
        const H=rows[0].map(x=>String(x||'').toLowerCase());
        const iName = H.findIndex(h=>h.includes('name')||h==='item');
        const iCat  = H.findIndex(h=>h.includes('cat'));
        const iSell = H.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
        const iStock= H.findIndex(h=>h.includes('stock'));
        const iNote = H.findIndex(h=>h.includes('notes')||h.includes('desc'));
        for(const r of rows.slice(1)){
          const name=String(r[iName]||'').trim(); if(!name) continue;
          const category=String(r[iCat]||'').trim();
          const sell=Number(r[iSell]||0);
          const stock = (r[iStock]===''||r[iStock]==null)? '' : Number(r[iStock]);
          const notes = String(r[iNote]||'').trim();
          const id = idify(name+'|'+category);
          refItems.child(id).set({ id, name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY()), stock, notes, _ts:now() });
        }
        alert('Imported!');
      }catch(e){ console.error(e); alert('Import failed'); }
    };

    $('#recalcPct').onclick = ()=>{
      for(const it of items){
        const sell=Number(it.sellPrice ?? it.price ?? 0);
        refItems.child(it.id).update({ buyPrice: Math.round(sell * BUY()) });
      }
      alert('Recalculated buy prices');
    };

    $('#clearAll').onclick = async ()=>{
      if(!db){ alert('Connect first'); return; }
      if(!confirm('Delete ALL items for this shop?')) return;
      await refItems.remove();
      alert('All items cleared');
    };

    // boot
    (function(){ const cfg=loadCfg(); if(cfg.shopId) connect(); })();
  </script>
</body>
</html>
