<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🌸 JJBlossoms — Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .input{width:100%;padding:.5rem .75rem;border-radius:.75rem;border:1px solid #cbd5e1}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .9rem;border-radius:.75rem;border:1px solid #cbd5e1;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
    .chip{font-size:.7rem;background:#0f172a0d;border:1px solid #e2e8f0;border-radius:999px;padding:.15rem .5rem}
    table input{min-width:5rem}
    dialog::backdrop{background:rgb(2 6 23/.55)}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">🌸 JJBlossoms — Admin</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pokémon. Requests from the site show at the bottom.</p>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn" href="./index.html">🏠 Back to site</a>
        <button id="saveCfg" class="btn">💾 Save config</button>
        <button id="reload" class="btn">🔄 Reload</button>
        <button id="signOut" class="btn">🚪 Sign out</button>
      </div>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms"/>
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here' />
      </div>
      <div class="text-xs text-slate-500">
        Firebase Console → Project settings → General → Your apps → Web → copy the config object. Enable <b>Authentication → Anonymous</b> and <b>Realtime Database</b>.
      </div>
      <div class="flex items-center gap-2 text-sm"><div>Status:</div><div id="status" class="font-semibold text-slate-700">Not connected</div></div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="importCsv" class="btn">📥 Import items from <b>shop.csv</b></button>
        <label class="flex items-center gap-2">🧮 Buy % <input id="buyPct" type="number" min="1" max="100" value="85" class="input w-20"/></label>
        <button id="recalc" class="btn">↻ Recalculate buy prices</button>
        <button id="exportCsv" class="btn">⬇️ Export items.csv</button>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items"/>
            <select id="catItems" class="input"></select>
          </div>
        </div>
        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Item</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- Pokémon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pokémon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search Pokémon">
          </div>
        </div>
        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price ($)" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input" id="pkSize" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>
          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Extra notes (IVs/EVs/Moves, etc.)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Pokémon</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left"><th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Requests -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Requests (from site)</h2>
        <div class="flex items-center gap-2">
          <input id="qReq" class="input" placeholder="Search IGN/Discord">
          <select id="statusReq" class="input"><option value="All">All</option><option value="open">open</option><option value="closed">closed</option></select>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0"><tr class="text-left"><th class="p-3">When</th><th class="p-3">IGN</th><th class="p-3">Discord</th><th class="p-3">Type</th><th class="p-3">Summary</th><th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead>
          <tbody id="rowsReq"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500">Edits save instantly. Export CSV any time for a backup (shop.csv).</p>
    </section>
  </div>

  <!-- Request modal -->
  <dialog id="reqDlg" class="w-[min(720px,calc(100%-2rem))] rounded-2xl p-0">
    <form method="dialog" class="p-4 space-y-3">
      <div class="flex items-center justify-between"><h3 class="brand text-xl">Request details</h3><button class="btn">Close</button></div>
      <div id="reqBody" class="space-y-3 text-sm"></div>
      <div class="flex items-center justify-between">
        <div class="space-x-2">
          <button id="markClosed" type="button" class="btn">✅ Mark closed</button>
          <button id="deleteReq" type="button" class="btn">🗑️ Delete</button>
        </div>
        <button class="btn">Done</button>
      </div>
    </form>
  </dialog>

  <script>
    // ---------- helpers ----------
    const $=s=>document.querySelector(s);
    const BUY_PCT=()=> Math.max(1, Math.min(100, Number($('#buyPct').value||85)))/100;
    const fmtMoney = n => `$${Number(n||0).toFixed(0)}`;
    const idify=s=>(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9));
    const now=()=>Date.now();

    let app,auth,db,refItems,refPk,refReq; let items=[],pokemon=[],requests=[];

    function tryJson(s){ try{return JSON.parse(s)}catch{return null} }

    async function connect(){
      const shop=$('#shopId').value.trim();
      const cfg=tryJson($('#cfgJson').value);
      if(!shop||!cfg){ $('#status').textContent='Missing config or Shop ID'; return; }
      try{
        app=firebase.apps.length?firebase.app():firebase.initializeApp(cfg);
        auth=firebase.auth();
        await auth.signInAnonymously();
        db=firebase.database();
        refItems=db.ref(`/shops/${shop}/items`);
        refPk   =db.ref(`/shops/${shop}/pokemon`);
        refReq  =db.ref(`/shops/${shop}/requests`);
        $('#status').textContent='Connected ✓';

        refItems.on('value',snap=>{ items=Object.values(snap.val()||{}); items.sort((a,b)=> (a.category||'').localeCompare(b.category||'')|| (a.name||'').localeCompare(b.name||'')); fillItemCats(); renderItems(); });
        refPk.on('value',snap=>{ pokemon=Object.values(snap.val()||{}); pokemon.sort((a,b)=> (a.owner||'').localeCompare(b.owner||'')|| (a.species||'').localeCompare(b.species||'')); renderPk(); });
        refReq.on('value',snap=>{ requests=Object.entries(snap.val()||{}).map(([id,v])=>({...v,id})); requests.sort((a,b)=> (b.ts||0)-(a.ts||0)); renderReq(); });
      }catch(e){ console.error(e); $('#status').textContent='Error connecting'; }
    }

    // ---------- items ----------
    function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}); }
    function removeItem(id){ refItems.child(id).remove(); }

    function fillItemCats(){ const sel=$('#catItems'); const cur=sel.value; const set=new Set(items.map(i=>i.category).filter(Boolean)); sel.innerHTML=''; sel.add(new Option('All','All')); [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c))); sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All'; }

    function renderItems(){ const q=$('#qItems').value.toLowerCase(); const cat=$('#catItems').value||'All'; const tb=$('#rowsItems'); tb.innerHTML='';
      const data=items.filter(it=> (cat==='All'||it.category===cat) && ((it.name||'').toLowerCase().includes(q)||(it.category||'').toLowerCase().includes(q)||(it.notes||'').toLowerCase().includes(q)) );
      for(const it of data){ const sell=Number(it.sellPrice??it.price??0); const tr=document.createElement('tr'); tr.innerHTML=`
        <td class="p-2">${it.name||''}</td>
        <td class="p-2">${it.category||''}</td>
        <td class="p-2"><input class="input w-28" value="${sell}" data-id="${it.id}" data-field="sellPrice"></td>
        <td class="p-2">${fmtMoney(Math.round(sell*BUY_PCT()))}</td>
        <td class="p-2 flex items-center gap-2">
          <button class="btn" data-act="dec" data-id="${it.id}">−</button>
          <input class="input w-20" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
          <button class="btn" data-act="inc" data-id="${it.id}">+</button>
        </td>
        <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
        <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`; tb.appendChild(tr); }
    }

    $('#addItemForm').addEventListener('submit', e=>{ e.preventDefault(); const name=$('#itemName').value.trim(); const category=$('#itemCat').value.trim(); const sell=Number($('#itemPrice').value||0); const stock=$('#itemStock').value===''?'':Number($('#itemStock').value); const notes=$('#itemNotes').value.trim(); const id=idify(name+'-'+category); patchItem(id,{id,name,category,sellPrice:sell,stock,notes}); e.target.reset(); });

    // inline edits
    document.addEventListener('input', e=>{ const t=e.target; if(t.matches('input[data-id]')){ const id=t.getAttribute('data-id'); const field=t.getAttribute('data-field'); let v=t.value; if(field==='stock'){ v=v===''?'':Number(v); } else if(field==='sellPrice'){ v=Number(v||0); } patchItem(id,{[field]:v}); }});
    document.addEventListener('click', e=>{ const t=e.target; const id=t.getAttribute('data-id'); if(t.dataset.act==='inc'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Number(it?.stock||0)+1}); } if(t.dataset.act==='dec'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Math.max(0,Number(it?.stock||0)-1)}); } if(t.dataset.act==='delItem'){ if(confirm('Delete item?')) removeItem(id); } });

    // import/export/recalc
    $('#importCsv').addEventListener('click', async ()=>{ try{ const res=await fetch('shop.csv',{cache:'no-store'}); if(!res.ok) return alert('shop.csv not found'); const txt=await res.text(); const wb=XLSX.read(txt,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true}); if(!rows.length) return alert('CSV empty'); const H=rows[0].map(x=>String(x||'').toLowerCase()); const idxName=H.findIndex(h=>h.includes('name')||h==='item'); const idxCat=H.findIndex(h=>h.includes('cat')); const idxSell=H.findIndex(h=>h.includes('sell price')||h.includes('sell_price')||h==='price'||h.includes('price')||h.includes('sell')); const idxStock=H.findIndex(h=>h.includes('stock')); const idxNotes=H.findIndex(h=>h.includes('notes')||h.includes('desc')); for(const r of rows.slice(1)){ const name=String(r[idxName]||'').trim(); if(!name) continue; const category=String(r[idxCat]||'').trim(); const sell=Number(r[idxSell]||0); const id=idify(name+'-'+category); const stock=(r[idxStock]===''||r[idxStock]==null)?'':Number(r[idxStock]); const notes=String(r[idxNotes]||'').trim(); patchItem(id,{id,name,category,sellPrice:sell,stock,notes}); } alert('Imported!'); }catch(e){ console.error(e); alert('Import failed'); }});

    $('#exportCsv').addEventListener('click', ()=>{ const rows=[["name","category","sell","buy(%)","stock","notes"]]; for(const it of items){ const sell=Number(it.sellPrice??it.price??0); rows.push([it.name||'',it.category||'',sell,Math.round(sell*BUY_PCT()),it.stock===''?'':it.stock,it.notes||'']); } const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'items'); XLSX.writeFile(wb,'shop_export.csv'); });

    $('#recalc').addEventListener('click', ()=>{ for(const it of items){ const sell=Number(it.sellPrice??it.price??0); patchItem(it.id,{buyPrice:Math.round(sell*BUY_PCT())}); } alert('Recalculated buy prices'); });

    // ---------- Pokémon ----------
    function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}); }
    function removePk(id){ refPk.child(id).remove(); }

    function renderPk(){ const q=$('#qPk').value.toLowerCase(); const owner=$('#pkOwnerFilter').value; const tb=$('#rowsPk'); tb.innerHTML=''; const data=pokemon.filter(p=> (owner==='All'||p.owner===owner) && ((p.species||'').toLowerCase().includes(q)||(p.nickname||'').toLowerCase().includes(q)||(p.nature||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)) ); for(const p of data){ const tr=document.createElement('tr'); tr.innerHTML=`<td class="p-2">${p.owner||''}</td><td class="p-2">${p.nickname?`${p.nickname} (${p.species})`:p.species}</td><td class="p-2">${p.level||''}</td><td class="p-2">${p.nature||''}</td><td class="p-2">${fmtMoney(p.price)}</td><td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td><td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`; tb.appendChild(tr); } }

    $('#addPkForm').addEventListener('submit', e=>{ e.preventDefault(); const owner=$('#pkOwner').value; const nickname=$('#pkNickname').value.trim(); const species=$('#pkSpecies').value.trim(); const id=idify(owner+'-'+species+'-'+Date.now()); const level=Number($('#pkLevel').value||0); const nature=$('#pkNature').value.trim(); const price=Number($('#pkPrice').value||0); const tera=$('#pkTera').value.trim(); const ball=$('#pkBall').value.trim(); const held=$('#pkHeld').value.trim(); const ability=$('#pkAbility').value.trim(); const size=$('#pkSize').value.trim(); const shiny=$('#pkShiny').checked; const neutered=$('#pkNeutered').checked; const moves=$('#pkMoves').value.trim(); const notes=$('#pkNotes').value.trim(); patchPk(id,{id,owner,nickname,species,level,nature,price,tera,ball,held,ability,size,shiny,neutered,moves,notes}); e.target.reset(); });

    document.addEventListener('input', e=>{ const t=e.target; if(t.matches('input[data-pk-id]')){ const id=t.getAttribute('data-pk-id'); const field=t.getAttribute('data-field'); patchPk(id,{[field]:t.value}); }});
    document.addEventListener('click', e=>{ const t=e.target; const id=t.getAttribute('data-id'); if(t.dataset.act==='delPk'){ if(confirm('Delete Pokémon?')) removePk(id); }});

    // ---------- Requests ----------
    function renderReq(){ const q=($('#qReq').value||'').toLowerCase(); const status=$('#statusReq').value; const tb=$('#rowsReq'); tb.innerHTML=''; for(const r of requests){ if(status!=='All' && (r.status||'open')!==status) continue; const who=((r.ign||'')+' '+(r.discord||'')).toLowerCase(); if(!who.includes(q)) continue; const total = (r.total!=null? r.total : (Array.isArray(r.sellItems)? r.sellItems.reduce((s,x)=> s + Number(x.price||0)*Number(x.qty||0),0): 0)); const tr=document.createElement('tr'); tr.innerHTML=`<td class="p-2 text-slate-500">${new Date(r.ts||0).toLocaleString()}</td><td class="p-2">${r.ign||''}</td><td class="p-2">${r.discord||''}</td><td class="p-2">${r.type||''}</td><td class="p-2">${r.summary||''}</td><td class="p-2">${total?fmtMoney(total):''}</td><td class="p-2"><span class="chip">${r.status||'open'}</span></td><td class="p-2"><button class="btn" data-act="openReq" data-id="${r.id}">Open</button></td>`; tb.appendChild(tr); } }

    function showReqModal(r){ const body=$('#reqBody'); const lines=[]; if(r.detailsText){ lines.push(`<div><b>Message:</b> ${r.detailsText}</div>`); } if(Array.isArray(r.sellItems)&&r.sellItems.length){ const rows=r.sellItems.map(it=>`<tr><td class='p-2 border'>${it.name||''}</td><td class='p-2 border text-right'>${it.qty||0}</td><td class='p-2 border text-right'>${fmtMoney(it.price||0)}</td><td class='p-2 border text-right'>${fmtMoney((it.price||0)*(it.qty||0))}</td></tr>`).join(''); const total=r.sellItems.reduce((s,x)=> s + Number(x.price||0)*Number(x.qty||0),0); lines.push(`<div><b>Selling items</b><div class='overflow-auto rounded border mt-1'><table class='min-w-full text-sm'><thead class='bg-slate-50'><tr><th class='p-2 text-left'>Item</th><th class='p-2 text-right'>Qty</th><th class='p-2 text-right'>Price</th><th class='p-2 text-right'>Line total</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td colspan='3' class='p-2 text-right font-semibold'>Total</td><td class='p-2 text-right font-semibold'>${fmtMoney(total)}</td></tr></tfoot></table></div></div>`); }
      body.innerHTML = `<div class='grid grid-cols-2 gap-2 text-sm'><div><b>When:</b> ${new Date(r.ts||0).toLocaleString()}</div><div><b>Status:</b> ${r.status||'open'}</div><div><b>IGN:</b> ${r.ign||''}</div><div><b>Discord:</b> ${r.discord||''}</div><div><b>Type:</b> ${r.type||''}</div><div><b>Summary:</b> ${r.summary||''}</div></div>` + (lines.length? `<div class='mt-2 space-y-2'>${lines.join('')}</div>` : `<div class='text-slate-500'>No extra details provided.</div>`);
      $('#markClosed').onclick = ()=> refReq.child(r.id).update({status:'closed'});
      $('#deleteReq').onclick   = ()=> { if(confirm('Delete this request?')) refReq.child(r.id).remove(); };
      $('#reqDlg').showModal();
    }

    document.addEventListener('click', e=>{ const t=e.target; if(t.dataset.act==='openReq'){ const r=requests.find(x=>x.id===t.getAttribute('data-id')); if(r) showReqModal(r); }});

    // ---------- wire up ----------
    $('#saveCfg').addEventListener('click', connect);
    $('#reload').addEventListener('click', connect);
    $('#qItems').addEventListener('input', renderItems); $('#catItems').addEventListener('change', renderItems);
    $('#qPk').addEventListener('input', renderPk); $('#pkOwnerFilter').addEventListener('change', renderPk);
    $('#qReq').addEventListener('input', renderReq); $('#statusReq').addEventListener('change', renderReq);
    $('#signOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); $('#status').textContent='Signed out'; }catch(e){ console.error(e); }});

    // optional: prefill your config to make life easier
    document.addEventListener('DOMContentLoaded',()=>{
      const prefill={
        apiKey:"AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
        authDomain:"jjblossom-35083.firebaseapp.com",
        databaseURL:"https://jjblossom-35083-default-rtdb.firebaseio.com",
        projectId:"jjblossom-35083",
        storageBucket:"jjblossom-35083.firebasestorage.app",
        messagingSenderId:"480122553743",
        appId:"1:480122553743:web:04bf017d5e16f28fd477fa",
        measurementId:"G-GVCG3PTNVP"
      };
      $('#cfgJson').value=JSON.stringify(prefill);
    });
  </script>
</body>
</html>
