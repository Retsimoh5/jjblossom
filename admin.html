<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- CSV reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
    .cell-num{ width:6.5rem }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pok√©mon. Changes sync instantly to the public site.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn">üè† Back to site</a>
        <button id="saveCfg" class="btn">üíæ Save config</button>
        <button id="reload" class="btn">üîÑ Reload</button>
        <button id="signOut" class="btn">üö™ Sign out</button>
      </div>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
      </div>
      <div class="text-xs text-slate-500">
        Firebase Console ‚Üí Project settings ‚Üí General ‚Üí Your apps ‚Üí Web ‚Üí copy the config object. Enable
        <b>Authentication ‚Üí Anonymous</b> and <b>Realtime Database</b>.
      </div>
      <div class="flex items-center flex-wrap gap-3">
        <div class="text-sm">Status: <b id="status" class="text-slate-700">Not connected</b></div>
        <div class="flex items-center gap-2">
          <label class="text-sm">Buy %</label>
          <input id="buyRate" class="input w-24" type="number" min="0" max="100" step="1" value="85">
          <button id="recalc" class="btn">üßÆ Recalculate Buy</button>
        </div>
        <button id="importCsv" class="btn">üì• Import items from <b>shop.csv</b></button>
        <button id="clearAll" class="btn">üßπ Clear ALL items</button>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items/categories/notes">
            <select id="catItems" class="input"></select>
          </div>
        </div>

        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Item</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Name</th>
                <th class="p-3">Category</th>
                <th class="p-3">Sell ($)</th>
                <th class="p-3">Buy ($)</th>
                <th class="p-3">Stock</th>
                <th class="p-3">Notes</th>
                <th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
        <p class="text-xs text-slate-500">Tip: you can edit Sell, Stock, and Notes inline in the table.</p>
      </section>

      <!-- Pok√©mon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pok√©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input">
              <option>All</option><option>Yerttty</option><option>Jonfiin</option>
            </select>
            <input id="qPk" class="input" placeholder="Search Pok√©mon">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price ($)" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Notes (IVs/EVs/Size/Shiny/Neutered etc.)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Pok√©mon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th>
                <th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="text-xs text-slate-500">Use search/filters to narrow, then edit inline. Buy = round(Sell √ó Buy%).</p>
  </div>

  <script>
    // ---------- helpers ----------
    const LS='jjb_admin_cfg_v3';
    let app,auth,db,refItems,refPk;
    let items=[], pokemon=[];
    const $ = s => document.querySelector(s);
    const now = () => Date.now();
    const tryParse = s => { try { return JSON.parse(s); } catch { return null; } };
    const saveCfgLocal = () => {
      const cfg = { shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value), buyRate: Number($('#buyRate').value||85) };
      localStorage.setItem(LS, JSON.stringify(cfg));
    };
    const loadCfgLocal = () => {
      try {
        const d = JSON.parse(localStorage.getItem(LS) || '{}');
        if (d.shopId) $('#shopId').value = d.shopId;
        if (d.cfg) $('#cfgJson').value = JSON.stringify(d.cfg);
        if (Number.isFinite(d.buyRate)) $('#buyRate').value = d.buyRate;
        return d;
      } catch { return {}; }
    };
    const idify = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    const getBuyRate = () => Math.max(0, Math.min(100, Number($('#buyRate').value || 85))) / 100;

    // ---------- Firebase connect ----------
    async function connect() {
      const shop = $('#shopId').value.trim();
      const cfg = tryParse($('#cfgJson').value);
      if (!shop || !cfg) { $('#status').textContent = 'Missing config or Shop ID'; return; }

      try {
        app = firebase.apps.length ? firebase.app() : firebase.initializeApp(cfg);
        auth = firebase.auth();
        await auth.signInAnonymously();
        db = firebase.database();
        refItems = db.ref(`/shops/${shop}/items`);
        refPk    = db.ref(`/shops/${shop}/pokemon`);
        $('#status').textContent = 'Connected ‚úì';

        refItems.on('value', snap => {
          const v = snap.val() || {};
          items = Object.values(v).sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
          fillItemCats();
          renderItems();
        });

        refPk.on('value', snap => {
          const v = snap.val() || {};
          pokemon = Object.values(v).sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||'')); 
          renderPk();
        });

      } catch (e) {
        console.error(e);
        $('#status').textContent = 'Error connecting';
      }
    }

    // ---------- Items UI ----------
    function fillItemCats(){
      const sel = $('#catItems'); const cur = sel.value;
      const set = new Set(items.map(i=>i.category).filter(Boolean));
      sel.innerHTML='';
      sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      sel.value = [...sel.options].some(o=>o.value===cur) ? cur : 'All';
    }

    function renderItems(){
      const q = $('#qItems').value.toLowerCase();
      const cat = $('#catItems').value || 'All';
      const tb = $('#rowsItems'); tb.innerHTML = '';

      const data = items.filter(it =>
        (cat==='All' || it.category===cat) &&
        ((it.name||'').toLowerCase().includes(q) ||
         (it.category||'').toLowerCase().includes(q) ||
         (it.notes||'').toLowerCase().includes(q))
      );
      const rate = getBuyRate();

      for (const it of data){
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        const buy  = Math.round(sell * rate);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2"><input class="input cell-num" type="number" value="${sell}" data-id="${it.id}" data-field="sellPrice"></td>
          <td class="p-2">$${buy}</td>
          <td class="p-2 flex items-center gap-2">
            <button class="btn" data-act="dec" data-id="${it.id}">‚àí</button>
            <input class="input cell-num" type="number" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
            <button class="btn" data-act="inc" data-id="${it.id}">+</button>
          </td>
          <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    function patchItem(id,changes){
      const cur = items.find(x=>x.id===id) || {id};
      refItems.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error);
    }
    function removeItem(id){ refItems.child(id).remove().catch(console.error); }

    // ---------- Pok√©mon UI ----------
    function renderPk(){
      const q = $('#qPk').value.toLowerCase();
      const owner = $('#pkOwnerFilter').value;
      const tb = $('#rowsPk'); tb.innerHTML = '';
      const data = pokemon.filter(p =>
        (owner==='All'||p.owner===owner) &&
        ((p.species||'').toLowerCase().includes(q) ||
         (p.nickname||'').toLowerCase().includes(q) ||
         (p.nature||'').toLowerCase().includes(q) ||
         (p.notes||'').toLowerCase().includes(q))
      );
      for (const p of data){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${p.owner||''}</td>
          <td class="p-2">${p.nickname?`${p.nickname} (${p.species})`:p.species}</td>
          <td class="p-2">${p.level||''}</td>
          <td class="p-2">${p.nature||''}</td>
          <td class="p-2"><input class="input cell-num" type="number" value="${Number(p.price||0)}" data-pk-id="${p.id}" data-field="price"></td>
          <td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    function patchPk(id,changes){
      const cur = pokemon.find(x=>x.id===id) || {id};
      refPk.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error);
    }
    function removePk(id){ refPk.child(id).remove().catch(console.error); }

    // ---------- Events ----------
    // Save / reload / signout
    $('#saveCfg').addEventListener('click', ()=>{ saveCfgLocal(); connect(); });
    $('#reload').addEventListener('click', ()=> connect());
    $('#signOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); $('#status').textContent='Signed out'; }catch(e){ console.error(e);} });

    // Filters / search
    $('#qItems').addEventListener('input', renderItems);
    $('#catItems').addEventListener('change', renderItems);
    $('#qPk').addEventListener('input', renderPk);
    $('#pkOwnerFilter').addEventListener('change', renderPk);
    $('#buyRate').addEventListener('input', ()=>{ saveCfgLocal(); renderItems(); });

    // Add/Update item
    $('#addItemForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#itemName').value.trim();
      const category = $('#itemCat').value.trim();
      const sell = Number($('#itemPrice').value||0);
      const stock = $('#itemStock').value==='' ? '' : Number($('#itemStock').value);
      const notes = $('#itemNotes').value.trim();
      const id = idify(name+'|'+category);
      patchItem(id,{ id, name, category, sellPrice: sell, stock, notes });
      e.target.reset();
    });

    // Inline edits (items + pokemon)
    document.addEventListener('input', (e)=>{
      const t=e.target;
      if (t.matches('input[data-id]')) {
        const id=t.getAttribute('data-id');
        const field=t.getAttribute('data-field');
        let v=t.value;
        if (field==='sellPrice' || field==='stock') v = v==='' ? '' : Number(v);
        patchItem(id, { [field]: v });
      }
      if (t.matches('input[data-pk-id]')) {
        const id=t.getAttribute('data-pk-id');
        const field=t.getAttribute('data-field');
        const v = field==='price' ? Number(t.value||0) : t.value;
        patchPk(id, { [field]: v });
      }
    });

    // +/- stock & deletes
    document.addEventListener('click', (e)=>{
      const t=e.target;
      if (t.dataset.act==='inc') {
        const it = items.find(x=>x.id===t.dataset.id);
        patchItem(t.dataset.id, { stock: Number(it?.stock||0)+1 });
      }
      if (t.dataset.act==='dec') {
        const it = items.find(x=>x.id===t.dataset.id);
        patchItem(t.dataset.id, { stock: Math.max(0, Number(it?.stock||0)-1) });
      }
      if (t.dataset.act==='delItem') {
        if (confirm('Delete this item?')) removeItem(t.dataset.id);
      }
      if (t.dataset.act==='delPk') {
        if (confirm('Delete this Pok√©mon?')) removePk(t.dataset.id);
      }
    });

    // Recalculate Buy using current %
    $('#recalc').addEventListener('click', ()=>{
      if (!db) return alert('Connect first');
      const rate = getBuyRate();
      for (const it of items) {
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        const buy  = Math.round(sell * rate);
        patchItem(it.id, { buyPrice: buy });
      }
      alert('Buy prices recalculated.');
      renderItems();
    });

    // Import from shop.csv (requires connection so we can write to DB)
    $('#importCsv').addEventListener('click', async ()=>{
      if (!db) return alert('Connect first (Save config), then try Import again.');
      try{
        const res = await fetch('shop.csv',{cache:'no-store'});
        if (!res.ok) return alert('shop.csv not found at repo root');
        const text = await res.text();
        const wb = XLSX.read(text,{type:'string'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        if (!rows.length) return alert('CSV is empty');

        const headers = (rows[0]||[]).map(h=>String(h||'').toLowerCase());
        const findIdx = (...keys)=> headers.findIndex(h=> keys.some(k=> h.includes(k)));
        const idxName  = findIdx('name','item');
        const idxCat   = findIdx('category','cat','group','type');
        const idxPrice = findIdx('sell price','our price','listed price','price','amount','sell'); // prefer sell
        const idxStock = findIdx('stock','qty','quantity','amount in stock');
        const idxNotes = findIdx('notes','desc','description','note');

        for (let r=1; r<rows.length; r++){
          const row = rows[r]||[];
          const name = String(row[idxName]||'').trim(); if (!name) continue;
          const category = String(row[idxCat]||'').trim();
          const sell = Number(String(row[idxPrice]||'').toString().replace(/[^0-9.-]/g,'')||0);
          const stockRaw = row[idxStock];
          const stock = (stockRaw==='' || stockRaw==null) ? '' : Number(stockRaw);
          const notes = String(row[idxNotes]||'').trim();
          const id = idify(name+'|'+category+'|'+r);
          patchItem(id, { id, name, category, sellPrice: sell, stock, notes });
        }
        alert('Imported from CSV.');
      }catch(e){ console.error(e); alert('Import failed'); }
    });

    // Clear ALL items
    $('#clearAll').addEventListener('click', async ()=>{
      if (!db) return alert('Connect first');
      if (!confirm('Delete ALL items for this shop?')) return;
      try{ await refItems.remove(); alert('All items cleared'); } catch(e){ console.error(e); alert('Failed to clear'); }
    });

    // Boot
    loadCfgLocal(); // prefill if stored
    // Do not auto-connect until user clicks Save config once (prevents accidental wrong project)
  </script>
</body>
</html>
