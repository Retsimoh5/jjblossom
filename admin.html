<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ðŸŒ¸ JJBlossoms â€” Admin (inline price + sorting)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    th.sortable{ cursor:pointer }
    th.sortable .arrow{ opacity:.35 }
    th.sortable.active .arrow{ opacity:1 }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">ðŸŒ¸ JJBlossoms â€” Admin</h1>
        <p class="text-slate-600 text-sm">Connect once, then edit items/stock and add PokÃ©mon. Anonymous signâ€‘in to Firebase.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="saveCfg" class="btn">ðŸ’¾ Save config</button>
        <button id="reload" class="btn">ðŸ”„ Reload</button>
        <button id="signOut" class="btn">ðŸšª Sign out</button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="lg:col-span-2 card p-4 space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)">
          <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
        </div>
        <div class="text-xs text-slate-500">Firebase Console â†’ Project settings â†’ General â†’ Your apps â†’ Web â†’ copy the config object. Enable <b>Authentication â†’ Anonymous</b> and <b>Realtime Database</b>.</div>
        <div class="flex items-center gap-2 text-sm"><div>Status:</div><div id="status" class="font-semibold text-slate-700">Not connected</div></div>
      </div>
      <div class="card p-4 space-y-2">
        <div class="text-sm font-semibold">Quick actions</div>
        <button id="importCsv" class="btn">ðŸ“¥ Import items from shop.csv</button>
        <button id="recalc" class="btn">ðŸ§® Recalculate buy (85%)</button>
        <div class="flex items-center gap-2 text-sm">
          <label for="stepSel">Price step</label>
          <select id="stepSel" class="input">
            <option value="1">$1</option>
            <option value="10" selected>$10</option>
            <option value="100">$100</option>
            <option value="1000">$1,000</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items panel -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items">
            <select id="catItems" class="input"></select>
          </div>
        </div>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3 sortable" data-sort="name">Name <span class="arrow">â–²â–¼</span></th>
                <th class="p-3 sortable" data-sort="category">Category <span class="arrow">â–²â–¼</span></th>
                <th class="p-3 sortable" data-sort="sell">Sell <span class="arrow">â–²â–¼</span></th>
                <th class="p-3">Buy(85%)</th>
                <th class="p-3 sortable" data-sort="stock">Stock <span class="arrow">â–²â–¼</span></th>
                <th class="p-3">Notes</th>
                <th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- PokÃ©mon panel (unchanged UI from your working file) -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">PokÃ©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search PokÃ©mon">
          </div>
        </div>
        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" placeholder="Price" required>
          <input class="input col-span-2" id="pkNotes" placeholder="Notes (IVs/EVs/Moves, etc.)">
          <button class="btn btn-primary col-span-2" type="submit">âž• Add / Update PokÃ©mon</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left"><th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="text-xs text-slate-500">Tip: click a column header to sort. Edit prices inline. Use the step buttons to nudge quickly.</p>
  </div>

  <script>
    const BUY_RATE=0.85, LS='jjb_admin_cfg_v3'; let app,db,auth,refItems,refPk; let items=[], pokemon=[];
    let sortKey='name', sortDir=1; // 1 asc, -1 desc
    const $=s=>document.querySelector(s);
    const saveCfg=()=> localStorage.setItem(LS, JSON.stringify({ shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value) }));
    const loadCfg=()=>{ try{const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d;}catch{return{}} };
    const tryParse=s=>{ try{return JSON.parse(s)}catch{return null} };
    const now=()=>Date.now();
    const idify=s=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9));

    async function connect(){ const shop=$('#shopId').value.trim(); const cfg=tryParse($('#cfgJson').value); if(!shop||!cfg){ $('#status').textContent='Missing config or Shop ID'; return; }
      try{ app=firebase.apps.length? firebase.app(): firebase.initializeApp(cfg); auth=firebase.auth(); await auth.signInAnonymously(); db=firebase.database(); refItems=db.ref(`/shops/${shop}/items`); refPk=db.ref(`/shops/${shop}/pokemon`);
        $('#status').textContent='Connected âœ“';
        refItems.on('value',snap=>{ const v=snap.val()||{}; items=Object.values(v).sort(sorter()); fillItemCats(); renderItems(); });
        refPk.on('value',snap=>{ const v=snap.val()||{}; pokemon=Object.values(v); renderPk(); });
      }catch(e){ console.error(e); $('#status').textContent='Error connecting'; }
    }

    function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
    function removeItem(id){ refItems.child(id).remove().catch(console.error); }
    function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
    function removePk(id){ refPk.child(id).remove().catch(console.error); }

    function fillItemCats(){ const sel=$('#catItems'); const cur=sel.value; const set=new Set(items.map(i=>i.category).filter(Boolean)); sel.innerHTML=''; sel.add(new Option('All','All')); [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c))); sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All'; }

    function sorter(){ return (a,b)=>{
      const A=(sortKey==='sell'? Number(a.sellPrice??a.price??0): sortKey==='stock'? Number(a.stock??0): (a[sortKey]||'')).toString().toLowerCase();
      const B=(sortKey==='sell'? Number(b.sellPrice??b.price??0): sortKey==='stock'? Number(b.stock??0): (b[sortKey]||'')).toString().toLowerCase();
      if(A<B) return -1*sortDir; if(A>B) return 1*sortDir; return 0;
    } }

    function renderItems(){ const q=$('#qItems').value.toLowerCase(); const cat=$('#catItems').value||'All'; const tb=$('#rowsItems'); tb.innerHTML='';
      const data=items.filter(it=> (cat==='All'||it.category===cat) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)) ).sort(sorter());
      const step=Number($('#stepSel').value||10);
      for(const it of data){ const sell=Number(it.sellPrice??it.price||0); const buy=Math.round(sell*BUY_RATE);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2">
            <div class="flex items-center gap-1">
              <button class="btn" data-act="price" data-id="${it.id}" data-delta="-${step}">âˆ’${step}</button>
              <input class="input w-24" type="number" min="0" step="1" value="${sell}" data-id="${it.id}" data-field="sellPrice">
              <button class="btn" data-act="price" data-id="${it.id}" data-delta="${step}">+${step}</button>
            </div>
          </td>
          <td class="p-2">$${buy}</td>
          <td class="p-2">
            <div class="flex items-center gap-1">
              <button class="btn" data-act="stock" data-id="${it.id}" data-delta="-1">âˆ’</button>
              <input class="input w-20" type="number" step="1" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
              <button class="btn" data-act="stock" data-id="${it.id}" data-delta="1">+</button>
            </div>
          </td>
          <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
      document.querySelectorAll('th.sortable').forEach(th=>{ th.classList.toggle('active', th.dataset.sort===sortKey); });
    }

    function renderPk(){ const q=$('#qPk').value.toLowerCase(); const owner=$('#pkOwnerFilter').value; const tb=$('#rowsPk'); tb.innerHTML='';
      const data=pokemon.filter(p=> (owner==='All'||p.owner===owner) && ((p.species||'').toLowerCase().includes(q)||(p.nature||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)) );
      for(const p of data){ const tr=document.createElement('tr'); tr.innerHTML=`
        <td class="p-2">${p.owner||''}</td>
        <td class="p-2">${p.species||''}</td>
        <td class="p-2">${p.level||''}</td>
        <td class="p-2">${p.nature||''}</td>
        <td class="p-2">$${Number(p.price||0).toFixed(0)}</td>
        <td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td>
        <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`; tb.appendChild(tr); }
    }

    // Inline edits & nudges
    document.addEventListener('input', (e)=>{
      const t=e.target; if(t.matches('input[data-id]')){ const id=t.getAttribute('data-id'); const field=t.getAttribute('data-field'); let v=t.value; if(field==='stock'||field==='sellPrice'){ v = v===''? '': Number(v); } patchItem(id, { [field]: v }); }
      if(t.matches('input[data-pk-id]')){ const id=t.getAttribute('data-pk-id'); const field=t.getAttribute('data-field'); patchPk(id, { [field]: t.value }); }
    });

    document.addEventListener('click', (e)=>{
      const t=e.target; const id=t.getAttribute('data-id');
      if(t.dataset.act==='stock'){ const it=items.find(x=>x.id===id); const d=Number(t.dataset.delta); const next=Math.max(0,Number(it?.stock||0)+d); patchItem(id,{stock:next}); }
      if(t.dataset.act==='price'){ const it=items.find(x=>x.id===id); const d=Number(t.dataset.delta); const base=Number(it?.sellPrice??it?.price??0); const next=Math.max(0,base+d); patchItem(id,{sellPrice:next}); }
      if(t.dataset.act==='delItem'){ if(confirm('Delete item?')) removeItem(id); }
      if(t.dataset.act==='delPk'){ if(confirm('Delete PokÃ©mon?')) removePk(id); }
      if(t.matches('th.sortable')){ const key=t.dataset.sort; if(key===sortKey){ sortDir*=-1; } else { sortKey=key; sortDir=1; } renderItems(); }
    });

    // Import from shop.csv (same folder)
    $('#importCsv').addEventListener('click', async ()=>{
      try{ const res=await fetch('shop.csv',{cache:'no-store'}); if(!res.ok) return alert('shop.csv not found'); const txt=await res.text(); const wb=XLSX.read(txt,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true}); if(!rows.length) return alert('CSV empty'); const headers=rows[0].map(x=>String(x||'').toLowerCase()); const idxName=headers.findIndex(h=>h.includes('name')||h==='item'); const idxCat=headers.findIndex(h=>h.includes('cat')); const idxPrice=headers.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell')); const idxStock=headers.findIndex(h=>h.includes('stock')); const idxNotes=headers.findIndex(h=>h.includes('notes')||h.includes('desc')); const body=rows.slice(1); for(const r of body){ const name=String(r[idxName]||'').trim(); if(!name) continue; const category=String(r[idxCat]||'').trim(); const sell=Number(r[idxPrice]||0); const id=idify(name+'-'+category); patchItem(id,{ id, name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY_RATE), stock: r[idxStock]===''||r[idxStock]==null?'': Number(r[idxStock]), notes:String(r[idxNotes]||'').trim() }); } alert('Imported!'); }
      catch(e){ console.error(e); alert('Import failed'); }
    });

    $('#saveCfg').addEventListener('click', ()=>{ saveCfg(); connect(); });
    $('#reload').addEventListener('click', ()=> connect());
    $('#recalc').addEventListener('click', ()=>{ for(const it of items){ const sell=Number(it.sellPrice??it.price??0); patchItem(it.id,{ buyPrice: Math.round(sell*BUY_RATE) }); } alert('Recalculated buy prices'); });

    $('#qItems').addEventListener('input', renderItems); $('#catItems').addEventListener('change', renderItems);
    $('#qPk').addEventListener('input', renderPk); $('#pkOwnerFilter').addEventListener('change', renderPk);

    // boot
    const cfg=loadCfg(); if(cfg.shopId) connect();
  </script>
</body>
</html>
