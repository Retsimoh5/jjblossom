<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- CSV import helper -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
    .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    dialog::backdrop{ background: rgb(2 6 23 / .55); }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pok√©mon. Requests sync live.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn">üè† Back to site</a>
      </div>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
      </div>
      <div class="text-xs text-slate-500">
        Firebase Console ‚Üí Project settings ‚Üí General ‚Üí Your apps ‚Üí Web ‚Üí copy the config object. Enable
        <b>Authentication ‚Üí Anonymous</b> and <b>Realtime Database</b>.
      </div>
      <div class="flex items-center gap-2">
        <button id="saveCfg" class="btn">üíæ Save config</button>
        <button id="reloadCfg" class="btn">üîÑ Reload</button>
        <button id="signOut" class="btn">üö™ Sign out</button>
        <div class="ml-auto text-sm">Status: <span id="status" class="font-semibold text-slate-700">Not connected</span></div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items, notes...">
            <select id="catItems" class="input"></select>
            <button id="importCsv" class="btn">üì• Import shop.csv</button>
            <button id="recalc" class="btn">üßÆ Recalc buy (85%)</button>
            <button id="clearAll" class="btn">üßπ Clear ALL</button>
          </div>
        </div>

        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat"  placeholder="Category (e.g., DNA, Dungeon Frag)" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Item</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Name</th><th class="p-3">Category</th>
                <th class="p-3">Sell</th><th class="p-3">Buy(85%)</th>
                <th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- Pok√©mon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pok√©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search nickname/species/nature/notes">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input  class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input  class="input" id="pkSpecies"   placeholder="Species" required>
          <input  class="input" id="pkLevel"     type="number" min="1" placeholder="Level" required>
          <input  class="input" id="pkNature"    placeholder="Nature">
          <input  class="input" id="pkPrice"     type="number" min="0" placeholder="Price ($)" required>
          <input  class="input" id="pkTera"      placeholder="Tera Type (optional)">
          <input  class="input" id="pkBall"      placeholder="Caught Ball (optional)">
          <input  class="input" id="pkHeld"      placeholder="Held Item (optional)">
          <input  class="input" id="pkAbility"   placeholder="Ability (optional)">
          <input  class="input" id="pkSize"      placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny"    type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0‚Äì31)</div>
            <input class="input" id="ivHP"  type="number" min="0" max="31" placeholder="HP">
            <input class="input" id="ivATK" type="number" min="0" max="31" placeholder="ATK">
            <input class="input" id="ivDEF" type="number" min="0" max="31" placeholder="DEF">
            <input class="input" id="ivSPA" type="number" min="0" max="31" placeholder="SP.ATK">
            <input class="input" id="ivSPD" type="number" min="0" max="31" placeholder="SP.DEF">
            <input class="input" id="ivSPE" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0‚Äì252 each, optional)</div>
            <input class="input" id="evHP"  type="number" min="0" max="252" placeholder="HP">
            <input class="input" id="evATK" type="number" min="0" max="252" placeholder="ATK">
            <input class="input" id="evDEF" type="number" min="0" max="252" placeholder="DEF">
            <input class="input" id="evSPA" type="number" min="0" max="252" placeholder="SP.ATK">
            <input class="input" id="evSPD" type="number" min="0" max="252" placeholder="SP.DEF">
            <input class="input" id="evSPE" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input   class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Extra notes (optional)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Pok√©mon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Owner</th><th class="p-3">Nickname / Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Requests -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Requests (from site)</h2>
        <div class="flex items-center gap-2">
          <input id="qReq" class="input" placeholder="Search IGN/Discord/type/summary">
          <select id="reqFilterType" class="input">
            <option value="All">All</option>
            <option value="price-change">Price change</option>
            <option value="selling-items">Selling items</option>
            <option value="question">Question</option>
          </select>
        </div>
      </div>

      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0">
            <tr class="text-left">
              <th class="p-3">When</th>
              <th class="p-3">IGN</th>
              <th class="p-3">Discord</th>
              <th class="p-3">Type</th>
              <th class="p-3">Summary</th>
              <th class="p-3">Total</th>
              <th class="p-3">Status</th>
              <th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="rowsReq"></tbody>
        </table>
      </div>

      <!-- Modal -->
      <dialog id="reqDlg" class="p-0 rounded-xl w-[min(720px,calc(100vw-2rem))]">
        <div class="p-4 sm:p-6 space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="brand text-lg">Request Details</h3>
            <button id="reqDlgClose" class="btn">Close</button>
          </div>
          <div id="reqMeta" class="text-sm grid grid-cols-2 sm:grid-cols-3 gap-2"></div>

          <div id="reqDetailsWrap" class="space-y-2 hidden">
            <div class="text-sm font-semibold">Details / Notes</div>
            <pre id="reqDetails" class="bg-slate-50 p-3 rounded-md whitespace-pre-wrap"></pre>
          </div>

          <div id="reqItemsWrap" class="space-y-2 hidden">
            <div class="text-sm font-semibold">Items</div>
            <div class="overflow-auto rounded-lg border">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50"><tr class="text-left">
                  <th class="p-2">Name</th><th class="p-2">Qty</th><th class="p-2">Unit</th><th class="p-2">Line total</th>
                </tr></thead>
                <tbody id="reqItems"></tbody>
                <tfoot class="bg-slate-50">
                  <tr><td class="p-2 font-semibold" colspan="3">Total</td>
                    <td id="reqTotal" class="p-2 mono font-semibold"></td></tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="pt-2">
            <button id="reqDelete" class="btn">üóë Delete</button>
          </div>
        </div>
      </dialog>
    </section>

    <p class="text-xs text-slate-500">Changes sync instantly. Use search/filters to narrow, then edit inline or use +/‚àí buttons.</p>
  </div>

  <script>
    const BUY_RATE=0.85, LS='jjb_admin_cfg_v3';
    let app,db,auth,refItems,refPk,refReq;
    let items=[], pokemon=[], requests=[];
    const $=(s)=>document.querySelector(s);
    const tryParse=(s)=>{ try{return JSON.parse(s)}catch{return null} };
    const idify=(s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9));
    const now=()=>Date.now();
    const fmtDate=(ts)=> new Date(ts||Date.now()).toLocaleString();
    const money=(n)=>'$'+(Number(n||0).toFixed(0));
    function saveCfg(){ localStorage.setItem(LS, JSON.stringify({ shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value) })); }
    function loadCfg(){ try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d; }catch{return{}} }

    async function connect(){
      const shop=$('#shopId').value.trim();
      const cfg=tryParse($('#cfgJson').value);
      if(!shop||!cfg){ $('#status').textContent='Missing config or Shop ID'; return; }
      try{
        app=firebase.apps.length? firebase.app(): firebase.initializeApp(cfg);
        auth=firebase.auth();
        await auth.signInAnonymously();
        db=firebase.database();
        refItems=db.ref(`/shops/${shop}/items`);
        refPk   =db.ref(`/shops/${shop}/pokemon`);
        refReq  =db.ref(`/shops/${shop}/requests`);
        $('#status').textContent='Connected ‚úì';

        refItems.on('value',snap=>{ const v=snap.val()||{}; items=Object.values(v); renderItems(); fillItemCats(); });
        refPk.on('value',snap=>{ const v=snap.val()||{}; pokemon=Object.values(v); renderPk(); });
        refReq.on('value',snap=>{ const v=snap.val()||{}; requests=Object.entries(v).map(([id,rv])=>({id,...rv})).sort((a,b)=> (b.ts||0)-(a.ts||0)); renderReq(); });
      }catch(e){ console.error(e); $('#status').textContent='Error connecting'; }
    }

    /* ----------------- Items ----------------- */
    function fillItemCats(){
      const sel=$('#catItems'); const cur=sel.value;
      const set=new Set(items.map(i=>i.category).filter(Boolean));
      sel.innerHTML=''; sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All';
    }
    function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}); }
    function removeItem(id){ refItems.child(id).remove(); }
    function renderItems(){
      const q=$('#qItems').value.toLowerCase(); const cat=$('#catItems').value||'All';
      const tb=$('#rowsItems'); tb.innerHTML='';
      const data=items
        .filter(it=> (cat==='All'||it.category===cat) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)))
        .sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
      for(const it of data){
        const sell=Number(it.sellPrice ?? it.price ?? 0);
        const buy =Number(it.buyPrice ?? Math.round(sell*BUY_RATE));
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2"><input class="input w-24 mono" value="${sell}" data-id="${it.id}" data-field="sellPrice"></td>
          <td class="p-2 mono">${Math.round(buy)}</td>
          <td class="p-2 flex items-center gap-2">
            <button class="btn" data-act="dec" data-id="${it.id}">‚àí</button>
            <input class="input w-20 mono" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
            <button class="btn" data-act="inc" data-id="${it.id}">+</button>
          </td>
          <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }
    $('#addItemForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name=$('#itemName').value.trim();
      const category=$('#itemCat').value.trim();
      const sell=Number($('#itemPrice').value||0);
      const stock=$('#itemStock').value===''? '': Number($('#itemStock').value);
      const notes=$('#itemNotes').value.trim();
      const id=idify(name+'-'+category);
      patchItem(id,{ id, name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY_RATE), stock, notes });
      e.target.reset();
    });
    document.addEventListener('input',(e)=>{
      const t=e.target; if(!t.matches('input[data-id]')) return;
      const id=t.getAttribute('data-id'); const field=t.getAttribute('data-field'); let v=t.value;
      if(field==='stock') v = v===''? '': Number(v);
      if(field==='sellPrice') v = Number(v||0);
      patchItem(id,{ [field]: v, ...(field==='sellPrice'? {buyPrice:Math.round(Number(v||0)*BUY_RATE)} : {}) });
    });
    document.addEventListener('click',(e)=>{
      const t=e.target; const id=t.getAttribute('data-id'); if(!id) return;
      if(t.dataset.act==='inc'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Number(it?.stock||0)+1}); }
      if(t.dataset.act==='dec'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Math.max(0,Number(it?.stock||0)-1)}); }
      if(t.dataset.act==='delItem'){ if(confirm('Delete item?')) removeItem(id); }
    });
    $('#qItems').addEventListener('input', renderItems);
    $('#catItems').addEventListener('change', renderItems);
    $('#recalc').addEventListener('click', ()=>{ for(const it of items){ const sell=Number(it.sellPrice??it.price??0); patchItem(it.id,{ buyPrice: Math.round(sell*BUY_RATE) }); } alert('Recalculated buy prices'); });
    $('#clearAll').addEventListener('click', async ()=>{
      if(!confirm('Delete ALL items for this shop?')) return;
      await refItems.remove(); alert('All items cleared');
    });

    // CSV import
    $('#importCsv').addEventListener('click', async ()=>{
      if(!db) return alert('Connect first (Save config), then try Import again.');
      try{
        const res=await fetch('shop.csv',{cache:'no-store'});
        if(!res.ok) return alert('shop.csv not found');
        const txt=await res.text();
        const wb=XLSX.read(txt,{type:'string'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        if(!rows.length) return alert('CSV empty');

        const H=rows[0].map(h=>String(h||'').toLowerCase());
        const idxName = H.findIndex(h=>h.includes('name')||h==='item');
        const idxCat  = H.findIndex(h=>h.includes('cat'));
        const idxSell = H.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
        const idxStock= H.findIndex(h=>h.includes('stock'));
        const idxNotes= H.findIndex(h=>h.includes('notes')||h.includes('desc'));

        for(const r of rows.slice(1)){
          const name=String(r[idxName]||'').trim(); if(!name) continue;
          const category=String(r[idxCat]||'').trim();
          const sell=Number(r[idxSell]||0);
          const id=idify(name+'-'+category);
          patchItem(id,{ id, name, category, sellPrice:sell, buyPrice:Math.round(sell*BUY_RATE),
            stock: r[idxStock]===''||r[idxStock]==null?'': Number(r[idxStock]),
            notes:String(r[idxNotes]||'').trim()
          });
        }
        alert('Imported!');
      }catch(e){ console.error(e); alert('Import failed'); }
    });

    /* ----------------- Pok√©mon ----------------- */
    function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}); }
    function removePk(id){ refPk.child(id).remove(); }
    function renderPk(){
      const q=$('#qPk').value.toLowerCase(); const owner=$('#pkOwnerFilter').value; const tb=$('#rowsPk'); tb.innerHTML='';
      const data=pokemon
        .filter(p=> (owner==='All'||p.owner===owner) && ((p.species||'').toLowerCase().includes(q)||(p.nickname||'').toLowerCase().includes(q)||(p.nature||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)))
        .sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||''));
      for(const p of data){
        const label = p.nickname ? `${p.nickname} (${p.species})` : (p.species||'');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${p.owner||''}</td>
          <td class="p-2">${label}</td>
          <td class="p-2">${p.level||''}</td>
          <td class="p-2">${p.nature||''}</td>
          <td class="p-2 mono">${money(p.price)}</td>
          <td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }
    $('#addPkForm').addEventListener('submit',(e)=>{
      e.preventDefault();
      const owner=$('#pkOwner').value;
      const nickname=$('#pkNickname').value.trim();
      const species=$('#pkSpecies').value.trim();
      const id=idify(owner+'-'+species+'-'+Date.now());
      const level=Number($('#pkLevel').value||0);
      const nature=$('#pkNature').value.trim();
      const price=Number($('#pkPrice').value||0);
      const tera=$('#pkTera').value.trim();
      const ball=$('#pkBall').value.trim();
      const held=$('#pkHeld').value.trim();
      const ability=$('#pkAbility').value.trim();
      const size=$('#pkSize').value.trim();
      const shiny=$('#pkShiny').checked; const neutered=$('#pkNeutered').checked;
      const ivs={ hp:+($('#ivHP').value||0), atk:+($('#ivATK').value||0), def:+($('#ivDEF').value||0), spa:+($('#ivSPA').value||0), spd:+($('#ivSPD').value||0), spe:+($('#ivSPE').value||0) };
      const evs={ hp:+($('#evHP').value||0), atk:+($('#evATK').value||0), def:+($('#evDEF').value||0), spa:+($('#evSPA').value||0), spd:+($('#evSPD').value||0), spe:+($('#evSPE').value||0) };
      const moves=$('#pkMoves').value.trim();
      const notes=$('#pkNotes').value.trim();
      patchPk(id,{ id, owner, nickname, species, level, nature, price, tera, ball, held, ability, size, shiny, neutered, ivs, evs, moves, notes });
      e.target.reset();
    });
    document.addEventListener('input',(e)=>{
      const t=e.target; if(!t.matches('input[data-pk-id]')) return;
      const id=t.getAttribute('data-pk-id'); const field=t.getAttribute('data-field');
      patchPk(id,{ [field]: t.value });
    });
    document.addEventListener('click',(e)=>{
      const t=e.target; if(t.dataset.act==='delPk'){ const id=t.getAttribute('data-id'); if(confirm('Delete Pok√©mon?')) removePk(id); }
    });
    $('#qPk').addEventListener('input', renderPk);
    $('#pkOwnerFilter').addEventListener('change', renderPk);

    /* ----------------- Requests ----------------- */
    function renderReq(){
      const q=($('#qReq').value||'').toLowerCase();
      const f=($('#reqFilterType').value||'All');
      const tb=$('#rowsReq'); tb.innerHTML='';
      const data=requests
        .filter(r=>{
          const t=(r.type||'').toLowerCase();
          const s=((r.summary||'')+(r.ign||'')+(r.discord||'')).toLowerCase();
          return (f==='All'||t===f) && s.includes(q);
        });
      for(const r of data){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${fmtDate(r.ts)}</td>
          <td class="p-2">${r.ign||''}</td>
          <td class="p-2">${r.discord||''}</td>
          <td class="p-2">${r.type||''}</td>
          <td class="p-2">${r.summary||''}</td>
          <td class="p-2 mono">${r.total!=null? money(r.total): ''}</td>
          <td class="p-2">${r.status||'open'}</td>
          <td class="p-2">
            <button class="btn" data-act="openReq" data-id="${r.id}">Open</button>
            <button class="btn" data-act="delReq"  data-id="${r.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    $('#qReq').addEventListener('input', renderReq);
    $('#reqFilterType').addEventListener('change', renderReq);

    function openReqDialog(req){
      // Meta
      $('#reqMeta').innerHTML = `
        <div><span class="text-slate-500">When:</span> ${fmtDate(req.ts)}</div>
        <div><span class="text-slate-500">IGN:</span> ${req.ign||''}</div>
        <div><span class="text-slate-500">Discord:</span> ${req.discord||''}</div>
        <div><span class="text-slate-500">Type:</span> ${req.type||''}</div>
        <div><span class="text-slate-500">Status:</span> ${req.status||'open'}</div>
      `;

      // Details / notes (free text)
      const details = (req.details || req.message || (req.payload && (req.payload.details||req.payload.message)) || '').trim();
      if(details){
        $('#reqDetailsWrap').classList.remove('hidden');
        $('#reqDetails').textContent = details;
      }else{
        $('#reqDetailsWrap').classList.add('hidden');
        $('#reqDetails').textContent = '';
      }

      // Items table
      // Accept any of these shapes:
      //  - req.cart = [{name, qty, price}, ...]
      //  - req.items = [...]
      //  - req.payload.items = [...]
      const itemsArr = (Array.isArray(req.cart) && req.cart)
                    || (Array.isArray(req.items) && req.items)
                    || (req.payload && Array.isArray(req.payload.items) && req.payload.items)
                    || [];
      if(itemsArr.length){
        const tb=$('#reqItems'); tb.innerHTML='';
        let total=0;
        for(const it of itemsArr){
          const name = it.name || it.title || '';
          const qty  = Number(it.qty||it.quantity||1);
          const unit = Number(it.price||it.unit||0);
          const line = unit*qty;
          total += line;
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2">${name}</td>
            <td class="p-2 mono">${qty}</td>
            <td class="p-2 mono">${money(unit)}</td>
            <td class="p-2 mono">${money(line)}</td>`;
          tb.appendChild(tr);
        }
        $('#reqTotal').textContent = money(req.total!=null? req.total: total);
        $('#reqItemsWrap').classList.remove('hidden');
      }else{
        $('#reqItems').innerHTML='';
        $('#reqTotal').textContent='';
        $('#reqItemsWrap').classList.add('hidden');
      }

      $('#reqDlg').showModal();
      $('#reqDelete').onclick = async ()=>{ if(confirm('Delete this request?')){ await refReq.child(req.id).remove(); $('#reqDlg').close(); } };
    }

    document.addEventListener('click', (e)=>{
      const t=e.target;
      if(t.id==='reqDlgClose'){ $('#reqDlg').close(); }
      if(t.dataset.act==='openReq'){
        const id=t.getAttribute('data-id');
        const req=requests.find(r=>r.id===id);
        if(req) openReqDialog(req);
      }
      if(t.dataset.act==='delReq'){
        const id=t.getAttribute('data-id');
        if(confirm('Delete this request?')) refReq.child(id).remove();
      }
    });

    /* ----------------- Wiring ----------------- */
    $('#saveCfg').addEventListener('click', ()=>{ saveCfg(); connect(); });
    $('#reloadCfg').addEventListener('click', ()=> connect());
    $('#signOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); $('#status').textContent='Signed out'; }catch(e){ console.error(e); } });

    // Boot with remembered config
    const remembered = loadCfg(); if(remembered.shopId) connect();

    // Optional: prefill your config for convenience (comment out if you prefer blank)
    document.addEventListener('DOMContentLoaded', ()=>{
      const prefill = {
        apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
        authDomain: "jjblossom-35083.firebaseapp.com",
        databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
        projectId: "jjblossom-35083",
        storageBucket: "jjblossom-35083.firebasestorage.app",
        messagingSenderId: "480122553743",
        appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
        measurementId: "G-GVCG3PTNVP"
      };
      if(!$('#cfgJson').value.trim()) $('#cfgJson').value = JSON.stringify(prefill);
    });
  </script>
</body>
</html>
