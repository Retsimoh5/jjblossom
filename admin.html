<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (matches your project) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .input{width:100%;padding:.5rem .75rem;border-radius:.75rem;border:1px solid #cbd5e1}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .9rem;border-radius:.75rem;border:1px solid #cbd5e1;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
    table input{min-width:5rem}
    .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .modal{background:#fff;border-radius:1rem;max-width:900px;width:100%}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connect below, then edit items/stock and add Pok√©mon. DNA/Dungeon Frags are handled correctly.</p>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn" href="./index.html">üè† Back to site</a>
        <button id="saveCfg" class="btn">üíæ Save config</button>
        <button id="reload" class="btn">üîÑ Reload</button>
        <button id="signOut" class="btn">üö™ Sign out</button>
      </div>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON object here'>
      </div>
      <div class="text-xs text-slate-500">
        Firebase Console ‚Üí Project settings ‚Üí General ‚Üí Your apps ‚Üí Web ‚Üí copy the config object.
        Enable <b>Authentication ‚Üí Anonymous</b> and <b>Realtime Database</b>.
        Basic rule: <code>{"rules":{"*.read":true,"shops":{"$shop":{"*.write":"auth != null"}}}}</code>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <div>Status:</div><div id="status" class="font-semibold text-slate-700">Not connected</div>
      </div>
    </section>

    <!-- Quick actions -->
    <section class="card p-4 flex flex-wrap gap-2 items-center">
      <button id="importCsv" class="btn">üì• Import items from <b>shop.csv</b></button>
      <div class="flex items-center gap-2">
        <span class="text-sm">Recalc buy %</span>
        <input id="buyPct" class="input w-20" type="number" min="1" max="99" value="85">
        <button id="recalc" class="btn">üßÆ Recalculate</button>
      </div>
      <button id="clearAll" class="btn">üßπ Clear ALL items</button>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <input id="qItems" class="input" placeholder="Search items">
            <select id="catItems" class="input"></select>
          </div>
        </div>
        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price ($)" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Item</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left">
                <th class="p-3">Name</th><th class="p-3">Category</th>
                <th class="p-3">Sell</th><th class="p-3">Buy</th>
                <th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- Pok√©mon -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pok√©mon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input">
              <option>All</option><option>Yerttty</option><option>Jonfiin</option>
            </select>
            <input id="qPk" class="input" placeholder="Search Pok√©mon">
          </div>
        </div>

        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price ($)" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input" id="pkSize" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0‚Äì31)</div>
            <input class="input" id="ivHP"  type="number" min="0" max="31" placeholder="HP">
            <input class="input" id="ivATK" type="number" min="0" max="31" placeholder="ATK">
            <input class="input" id="ivDEF" type="number" min="0" max="31" placeholder="DEF">
            <input class="input" id="ivSPA" type="number" min="0" max="31" placeholder="SP.ATK">
            <input class="input" id="ivSPD" type="number" min="0" max="31" placeholder="SP.DEF">
            <input class="input" id="ivSPE" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0‚Äì252 each, optional)</div>
            <input class="input" id="evHP"  type="number" min="0" max="252" placeholder="HP">
            <input class="input" id="evATK" type="number" min="0" max="252" placeholder="ATK">
            <input class="input" id="evDEF" type="number" min="0" max="252" placeholder="DEF">
            <input class="input" id="evSPA" type="number" min="0" max="252" placeholder="SP.ATK">
            <input class="input" id="evSPD" type="number" min="0" max="252" placeholder="SP.DEF">
            <input class="input" id="evSPE" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Extra notes (optional)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">‚ûï Add / Update Pok√©mon</button>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left"><th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr>
            </thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Requests -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Requests (from site)</h2>
        <div class="flex items-center gap-2">
          <input id="qReq" class="input" placeholder="Search IGN/Discord/subject...">
          <select id="reqFilter" class="input">
            <option value="All">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0">
            <tr class="text-left">
              <th class="p-3">When</th><th class="p-3">IGN</th><th class="p-3">Discord</th>
              <th class="p-3">Type</th><th class="p-3">Subject / Summary</th>
              <th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="rowsReq"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500">Edits save instantly. Export CSV any time for a backup (<code>shop.csv</code>).</p>
    </section>
  </div>

  <!-- Request modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal w-full max-w-3xl">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="brand text-lg">Request details</h3>
        <button id="mClose" class="btn">Close</button>
      </div>
      <div class="p-4 space-y-3" id="mBody"></div>
      <div class="p-4 border-t flex items-center justify-between">
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-sm"><input id="mClosed" type="checkbox"> Mark closed</label>
          <button id="mDelete" class="btn">üóëÔ∏è Delete</button>
        </div>
        <button id="mDone" class="btn btn-primary">Done</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- helpers ---------- */
    const $ = (s)=>document.querySelector(s);
    const $on = (el,ev,fn)=>el.addEventListener(ev,fn);
    const idify = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || ('id-'+Math.random().toString(36).slice(2,9));
    const fmtMoney = (n)=> '$'+Number(n||0).toFixed(0);
    const tsToText = (t)=> new Date(Number(t||Date.now())).toLocaleString();

    const BUY_DEFAULT = 0.85;
    let BUY_RATE = BUY_DEFAULT;

    /* ---------- state ---------- */
    let app, auth, db;
    let refItems, refPk, refReq;
    let items=[], pokemon=[], requests=[];
    const LS = 'jjb_admin_cfg_v3';

    const tryParse = (s)=>{ try{return JSON.parse(s)}catch{return null} };
    const saveCfg = ()=> localStorage.setItem(LS, JSON.stringify({ shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value) }));
    const loadCfg = ()=> { try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); if(d.shopId) $('#shopId').value=d.shopId; if(d.cfg) $('#cfgJson').value=JSON.stringify(d.cfg); return d; }catch{return {}} };

    /* ---------- connect ---------- */
    async function connect(){
      const shop = $('#shopId').value.trim();
      const cfg = tryParse($('#cfgJson').value);
      if(!shop || !cfg){ $('#status').textContent = 'Missing config or Shop ID'; return; }
      try{
        app = firebase.apps.length ? firebase.app() : firebase.initializeApp(cfg);
        auth = firebase.auth();
        await auth.signInAnonymously();
        db = firebase.database();

        refItems = db.ref(`/shops/${shop}/items`);
        refPk    = db.ref(`/shops/${shop}/pokemon`);
        refReq   = db.ref(`/shops/${shop}/requests`);

        $('#status').textContent = 'Connected ‚úì';

        refItems.on('value',(snap)=>{ const v=snap.val()||{}; items=Object.values(v).sort((a,b)=>(a.name||'').localeCompare(b.name||'')); fillItemCats(); renderItems(); });
        refPk.on('value',(snap)=>{ const v=snap.val()||{}; pokemon=Object.values(v).sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||'')); renderPk(); });
        refReq.on('value',(snap)=>{ const v=snap.val()||{}; requests=Object.values(v).sort((a,b)=> (b.ts||0)-(a.ts||0) ); renderReq(); });

      }catch(err){
        console.error(err);
        $('#status').textContent = 'Error connecting';
      }
    }

    /* ---------- items CRUD ---------- */
    function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:Date.now(),id}).catch(console.error); }
    function removeItem(id){ refItems.child(id).remove().catch(console.error); }
    function fillItemCats(){ const sel=$('#catItems'); const cur=sel.value; const set=new Set(items.map(i=>i.category).filter(Boolean)); sel.innerHTML=''; sel.add(new Option('All','All')); [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=>sel.add(new Option(c,c))); sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All'; }

    function renderItems(){
      const q = $('#qItems').value.toLowerCase();
      const cat = $('#catItems').value || 'All';
      const tb = $('#rowsItems'); tb.innerHTML='';
      const data = items.filter(it => (cat==='All'||it.category===cat) && ([it.name,it.category,it.notes].join(' ').toLowerCase().includes(q)) );
      for(const it of data){
        const sell = Number(it.sellPrice ?? it.price ?? 0);
        const buy  = Number(it.buyPrice ?? Math.round(sell*BUY_RATE));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2"><input class="input w-24" value="${sell}" data-id="${it.id}" data-field="sellPrice"></td>
          <td class="p-2">${fmtMoney(buy)}</td>
          <td class="p-2 flex items-center gap-2">
            <button class="btn" data-act="dec" data-id="${it.id}">‚àí</button>
            <input class="input w-20" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
            <button class="btn" data-act="inc" data-id="${it.id}">+</button>
          </td>
          <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    /* ---------- pokemon CRUD ---------- */
    function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:Date.now(),id}).catch(console.error); }
    function removePk(id){ refPk.child(id).remove().catch(console.error); }

    function renderPk(){
      const q = $('#qPk').value.toLowerCase();
      const owner = $('#pkOwnerFilter').value;
      const tb = $('#rowsPk'); tb.innerHTML='';
      const data = pokemon.filter(p=> (owner==='All'||p.owner===owner) && ([p.species,p.nickname,p.nature,p.notes].join(' ').toLowerCase().includes(q)));
      for(const p of data){
        const flags = [p.shiny?'‚ú® Shiny':null, p.neutered?'Neutered':null].filter(Boolean).join(' ¬∑ ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${p.owner||''}</td>
          <td class="p-2">${p.nickname?`${p.nickname} (${p.species})`:p.species}${flags?` ‚Äî ${flags}`:''}</td>
          <td class="p-2">${p.level||''}</td>
          <td class="p-2">${p.nature||''}</td>
          <td class="p-2">${fmtMoney(p.price)}</td>
          <td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td>
          <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    /* ---------- requests viewer ---------- */
    function renderReq(){
      const q = $('#qReq').value.toLowerCase();
      const filt = $('#reqFilter').value;
      const tb = $('#rowsReq'); tb.innerHTML='';
      const data = requests.filter(r=>{
        const s = [r.ign,r.discord,r.subject,r.summary].map(x=>x||'').join(' ').toLowerCase();
        const passQ = s.includes(q);
        const passF = (filt==='All') ? true : ((r.status||'open')===filt);
        return passQ && passF;
      });
      for(const r of data){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 whitespace-nowrap">${tsToText(r.ts)}</td>
          <td class="p-2">${r.ign||''}</td>
          <td class="p-2">${r.discord||''}</td>
          <td class="p-2">${r.type||''}</td>
          <td class="p-2">${r.subject||r.summary||'(no summary)'}</td>
          <td class="p-2">${fmtMoney(r.total)}</td>
          <td class="p-2"><span class="px-2 py-0.5 rounded-full text-xs ${ (r.status||'open')==='open' ? 'bg-emerald-100 text-emerald-700':'bg-slate-200 text-slate-700' }">${r.status||'open'}</span></td>
          <td class="p-2"><button class="btn" data-act="openReq" data-id="${r.id}">Open</button></td>`;
        tb.appendChild(tr);
      }
    }

    function openReqModal(id){
      const r = requests.find(x=>x.id===id); if(!r) return;
      const msg = r.message ?? r.details ?? '(no extra details provided)';
      const items = (r.items || r.sellItems || []).map(it=>{
        const qty = Number(it.qty||it.quantity||0);
        const price = Number(it.price||it.unitPrice||0);
        return { name: it.name||it.item||'?', qty, price, line: qty*price };
      });
      // If unit price not stored, try to derive from current shop items (by name)
      for(const it of items){
        if(!it.price || it.price===0){
          const live = itemsByName[it.name];
          if(live){ it.price = Number(live.buyPrice ?? Math.round((live.sellPrice||live.price||0)*BUY_RATE)); it.line = it.qty*it.price; }
        }
      }
      const total = (r.total!=null)? Number(r.total) : items.reduce((a,b)=>a+Number(b.line||0),0);

      // Build HTML
      const rows = items.length
        ? items.map(i=>`<tr><td class="p-2">${i.name}</td><td class="p-2 text-right">${i.qty}</td><td class="p-2 text-right">${fmtMoney(i.price)}</td><td class="p-2 text-right">${fmtMoney(i.line)}</td></tr>`).join('')
        : `<tr><td class="p-2 text-slate-500" colspan="4">No selling items were listed</td></tr>`;

      $('#mBody').innerHTML = `
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <div><b>When:</b> ${tsToText(r.ts)}</div>
            <div><b>IGN:</b> ${r.ign||''}</div>
            <div><b>Type:</b> ${r.type||''}</div>
          </div>
          <div>
            <div><b>Status:</b> ${r.status||'open'}</div>
            <div><b>Discord:</b> ${r.discord||''}</div>
            <div><b>Subject:</b> ${r.subject||r.summary||''}</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="text-sm font-semibold mb-1">Message:</div>
          <div class="p-3 rounded border bg-slate-50 whitespace-pre-wrap">${msg}</div>
        </div>

        <
